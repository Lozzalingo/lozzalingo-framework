# Lozzalingo Framework - Claude Guidelines

## Architecture
- Modular Flask admin framework with 11 modules (118+ endpoints)
- Zero-config init: `Lozzalingo(app)` registers all modules automatically
- Source of truth: extracted from Mario Pinto (`/Users/laurencestephan/Programming/Mario Pinto`)

## Critical Rules
1. **Never build from scratch** - extract working code from Mario Pinto first, then make framework-ready
2. **Admin = framework, User = site-specific** - never put user-facing features in framework
3. **Public frontend = hybrid** - framework provides routes/backend, project provides styled templates
4. **Optional imports** - all app-specific imports must use try/except pattern
5. **Never re-import inside functions** - causes `cannot access local variable` errors (shadows module-level import for entire function scope)

## Database Paths
- `Config.USER_DB`, `Config.NEWS_DB`, `Config.ANALYTICS_DB` - use these constants, never compute paths with `os.path.dirname(__file__)` (breaks inside Docker containers)
- DB_DIR defaults to `./databases/` relative to CWD, auto-created on init
- Three-tier resolution: env var > Flask app.config > Config class default

## Module Dependencies
- Email <-> Subscribers (email sends to subscriber lists)
- News Admin <-> News Public (shared NEWS_DB)
- Orders <-> Email (sends confirmation/shipping emails)
- Orders <-> InkThreadable (optional print fulfillment)
- All admin modules require `session['admin_id']` (set by dashboard auth)
- Analytics scripts auto-injected before `</body>` in all non-admin HTML responses

## Key Patterns
- Blueprint registration: `_register_modules()` in `lozzalingo/__init__.py` line 305
- Config resolution: app.config > Config class > os.getenv > default
- Email provider: `EMAIL_PROVIDER` config ('resend' or 'ses')
- YAML config mapping: `lozzalingo.yaml` keys map to internal config (line 218-252)

## When Modifying
- Update INTEGRATION.md if routes/config/interfaces change
- Update README.md if features change
- Test in real Flask app (Mario Pinto or crowd_sauced)
- Namespace templates under module name: `templates/[module-name]/`

## After Making Changes
- Run `python -m pytest tests/test_critical.py -q` after modifying any Python file
- Do not commit if tests fail. Fix the issue first
- If a test needs updating due to intentional changes, update the test too
