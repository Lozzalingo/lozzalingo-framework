<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects Editor - Admin</title>
    <script src="{{ url_for('admin.static', filename='js/admin-theme.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css">
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/newseditor.css') }}">
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/admin-theme.css') }}">
</head>
<body>
    {% include 'header.html' ignore missing %}

    <div class="editor-container">
        <header class="editor-header">
            <h1>Projects Editor</h1>
            <div class="header-actions">
                <button class="lz-theme-toggle" name="theme_toggle" onclick="toggleTheme()" aria-label="Toggle theme"><span class="theme-icon"></span></button>
                <a href="{{ url_for('admin.dashboard') }}" class="back-link">Back to Dashboard</a>
            </div>
        </header>

        <div class="editor-content">
            <div class="editor-form">
                <h2 id="formTitle">Create New Project</h2>

                <form id="projectForm" enctype="multipart/form-data">
                    <input type="hidden" id="projectId">

                    <div class="form-group">
                        <label for="title">Project Title *</label>
                        <input type="text" id="title" name="title" required placeholder="Enter project title...">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="year">Year (Start)</label>
                            <input type="number" id="year" name="year" placeholder="e.g. 2024" min="1990" max="2099">
                        </div>
                        <div class="form-group">
                            <label for="yearEnd">Year End</label>
                            <input type="number" id="yearEnd" name="year_end" placeholder="Leave blank for ongoing" min="1990" max="2099">
                            <small class="form-hint">Leave blank for ongoing projects</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectStatus">Activity</label>
                            <select id="projectStatus" name="project_status">
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                                <option value="retired">Retired</option>
                                <option value="limited">Limited</option>
                                <option value="one-off">One-Off</option>
                                <option value="experiment">Experiment</option>
                                <option value="academic">Academic</option>
                            </select>
                            <small class="form-hint">Shown as a label on the public page</small>
                        </div>
                        <div class="form-group">
                            <label for="grossEarnings">Gross Earnings (est.)</label>
                            <div style="display: flex; gap: 8px;">
                                <select id="earningsCurrency" name="earnings_currency" style="width: 70px; flex-shrink: 0;">
                                    <option value="£">£</option>
                                    <option value="$">$</option>
                                    <option value="€">€</option>
                                </select>
                                <input type="number" id="grossEarnings" name="gross_earnings" placeholder="e.g. 50000" min="0" step="0.01" style="flex: 1;">
                            </div>
                            <small class="form-hint">Leave blank and use label below for non-monetary projects</small>
                        </div>
                        <div class="form-group">
                            <label for="earningsLabel">Earnings Label</label>
                            <input type="text" id="earningsLabel" name="earnings_label" placeholder="e.g. Educational, Experiment, Marketing" maxlength="30">
                            <small class="form-hint">Shown instead of earnings when no monetary value (e.g. "Educational", "Experiment")</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="techSearchInput">Technologies</label>
                        <div class="tech-input-wrap" id="techInputWrap">
                            <div class="tech-tags" id="techTags"></div>
                            <input type="text" id="techSearchInput" autocomplete="off" placeholder="Type to search technologies...">
                            <div class="tech-dropdown" id="techDropdown"></div>
                            <div class="tech-category-picker" id="techCategoryPicker" style="display:none;">
                                <span class="tcp-label">New tech — pick category:</span>
                                <select id="techCategorySelect">
                                    <option value="software">Software</option>
                                    <option value="hardware">Hardware</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="clients">Clients</option>
                                    <option value="equipment">Equipment</option>
                                    <option value="logistics">Logistics</option>
                                    <option value="materials">Materials</option>
                                    <option value="services">Services</option>
                                    <option value="other">Other</option>
                                </select>
                                <button type="button" class="tcp-add" id="techCategoryAddBtn" name="tech_category_add">Add</button>
                                <button type="button" class="tcp-cancel" id="techCategoryCancelBtn" name="tech_category_cancel">Cancel</button>
                            </div>
                        </div>
                        <input type="hidden" id="technologies" name="technologies">
                        <small class="form-hint">Type to search & add — <a href="{{ url_for('projects_admin.tech_registry') }}" style="color: var(--lz-accent, #c4788a);">Manage Tech Registry</a></small>
                    </div>

                    <div class="form-group">
                        <label>Insights</label>
                        <div class="insights-input-wrap">
                            <div class="insights-add-row">
                                <select id="insightType">
                                    <option value="win">Wins</option>
                                    <option value="loss">Losses</option>
                                    <option value="takeaway">Takeaways</option>
                                </select>
                                <input type="text" id="insightText" placeholder="Add an insight...">
                                <button type="button" class="btn-secondary" id="insightAddBtn" name="insight_add">Add</button>
                            </div>
                            <table class="insights-table" id="insightsTable" style="display:none;">
                                <tbody id="insightsBody"></tbody>
                            </table>
                        </div>
                        <input type="hidden" id="insightsHidden" name="insights">
                    </div>

                    <div class="form-group">
                        <label>Gallery Layout</label>
                        <div class="gallery-layout-picker" id="galleryLayoutPicker">
                            <button type="button" class="gl-btn active" data-layout="single" name="gallery_layout_single">Single</button>
                            <button type="button" class="gl-btn" data-layout="carousel" name="gallery_layout_carousel">Carousel</button>
                            <button type="button" class="gl-btn" data-layout="grid" name="gallery_layout_grid">Grid</button>
                        </div>
                        <input type="hidden" id="galleryLayout" name="gallery_layout" value="single">
                    </div>

                    <div class="form-group">
                        <label>Hero Image Position</label>
                        <div class="focal-dragger" id="focalDragger">
                            <div class="focal-dragger-empty" id="focalDraggerEmpty">Add a gallery image to position</div>
                            <img id="focalDraggerImg" src="" alt="Drag to reposition" style="display:none;">
                            <div class="focal-dragger-hint" id="focalDraggerHint" style="display:none;">Drag to reposition</div>
                        </div>
                        <input type="hidden" id="heroImageAlign" name="hero_image_align" value="center 50%">
                        <small class="form-hint">Drag the preview up/down to control the hero crop</small>
                    </div>

                    <div class="form-group">
                        <label>Gallery Images</label>
                        <div class="gallery-thumbs" id="galleryThumbs"></div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                            <input type="file" id="imageFile" name="image" accept="image/*,.heic,.heif" style="flex:1;">
                            <button type="button" class="btn-secondary" id="browseImagesBtn" name="gallery_browse_images" style="white-space:nowrap;">Browse</button>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                            <input type="text" id="galleryUrlInput" placeholder="Paste image URL..." style="flex:1;">
                            <button type="button" class="btn-secondary" id="galleryAddUrlBtn" name="gallery_add_url" style="white-space:nowrap;">Add URL</button>
                        </div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                            <span class="progress-text" id="progressText">Uploading...</span>
                        </div>
                        <input type="hidden" id="galleryImagesHidden" name="gallery_images">
                        <input type="hidden" id="imageUrl" name="image_url">
                    </div>

                    <div class="form-group">
                        <label for="content">Project Description *</label>
                        <div id="editor"></div>
                        <input type="hidden" id="content" name="content">
                    </div>

                    <div class="form-group">
                        <label for="externalUrl">External URL</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="url" id="externalUrl" name="external_url" placeholder="https://example.github.io/project" style="flex: 1;">
                            <button type="button" class="btn-secondary" id="fetchExternalBtn" name="fetch_external_content" style="white-space:nowrap;" onclick="fetchExternalContent()">Fetch Content</button>
                            <span id="fetchStatus" style="font-size: 0.85em; white-space: nowrap;"></span>
                        </div>
                        <small class="form-hint">Embeds this page instead of content. Set excerpt &amp; meta description below for SEO.</small>
                        <textarea id="fetchedExternalContent" style="display:none;"></textarea>
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">SEO & Metadata</h3>
                        <div class="form-group">
                            <label for="excerpt">Excerpt</label>
                            <textarea id="excerpt" name="excerpt" rows="2" placeholder="Short description for previews (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="metaDescription">Meta Description</label>
                            <textarea id="metaDescription" name="meta_description" rows="2" placeholder="SEO description (optional)"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-primary" id="publishBtn" name="project_publish">Publish Project</button>
                        <button type="button" class="btn-secondary" id="draftBtn" name="project_save_draft">Save as Draft</button>
                        <button type="button" class="btn-secondary" id="cancelBtn" name="project_cancel_edit" style="display: none;">Cancel Edit</button>
                        <span id="saveFlash" class="save-flash" style="display:none;"></span>
                    </div>
                    <div id="statusIndicator" class="status-indicator" style="display: none;">
                        Visibility: <span id="currentStatus"></span> &nbsp;|&nbsp; Activity: <span id="currentProjectStatus"></span>
                    </div>
                </form>
            </div>

            <div class="articles-list">
                <div class="list-header">
                    <h2>Manage Projects</h2>
                    <div class="filter-controls">
                        <input type="text" id="projectSearch" class="filter-input" placeholder="Search projects...">
                        <select id="projectFilter" class="filter-select">
                            <option value="all">All</option>
                            <option value="published">Published</option>
                            <option value="draft">Drafts</option>
                        </select>
                        <span id="projectCount" class="item-count"></span>
                    </div>
                </div>
                <div id="projectsList"></div>
            </div>
        </div>
    </div>

    <!-- Image Browser Modal -->
    <div id="imageBrowserModal" class="ib-overlay" style="display:none;">
        <div class="ib-card">
            <div class="ib-header">
                <h3>Browse Images</h3>
                <button type="button" class="ib-close" id="ibCloseBtn" name="image_browser_close">&times;</button>
            </div>
            <div class="ib-tabs">
                <button type="button" class="ib-tab" data-folder="quick-links" name="image_browser_tab_quick_links">Quick Links</button>
                <button type="button" class="ib-tab" data-folder="blog" name="image_browser_tab_blog">Blog</button>
                <button type="button" class="ib-tab active" data-folder="projects" name="image_browser_tab_projects">Projects</button>
            </div>
            <div class="ib-body">
                <div id="ibGrid" class="ib-grid"></div>
            </div>
            <div class="ib-footer" id="ibFooter" style="display:none;">
                <span id="ibSelectedCount">0 selected</span>
                <button type="button" class="btn-primary" id="ibAddSelectedBtn" name="image_browser_add_selected">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- Filmstrip Modal -->
    <div id="filmstripModal" class="ib-overlay" style="display:none;">
        <div class="ib-card" style="max-width:800px;">
            <div class="ib-header">
                <h3 id="fsModalTitle">Insert Filmstrip</h3>
                <button type="button" class="ib-close" id="fsCloseBtn" name="filmstrip_close">&times;</button>
            </div>
            <div class="fs-body">
                <div class="fs-preview" id="fsPreview">
                    <p class="fs-empty" id="fsEmpty">No images added yet — upload, browse, or paste a URL below.</p>
                </div>
                <div class="fs-add-section">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <input type="file" id="fsFileInput" accept="image/*,.heic,.heif" multiple style="flex:1;">
                        <button type="button" class="btn-secondary" id="fsBrowseBtn" name="filmstrip_browse" style="white-space:nowrap;">Browse Library</button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                        <input type="text" id="fsUrlInput" placeholder="Paste image URL..." style="flex:1;">
                        <button type="button" class="btn-secondary" id="fsAddUrlBtn" name="filmstrip_add_url" style="white-space:nowrap;">Add URL</button>
                    </div>
                    <div class="upload-progress" id="fsUploadProgress" style="display:none;">
                        <div class="progress-bar"><div class="progress-fill" id="fsProgressFill"></div></div>
                        <span class="progress-text" id="fsProgressText">Uploading...</span>
                    </div>
                </div>
                <div class="fs-actions">
                    <button type="button" class="btn-primary" id="fsInsertBtn" name="filmstrip_insert">Insert Filmstrip</button>
                    <button type="button" class="btn-secondary" id="fsCancelBtn" name="filmstrip_cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Modal (sub-modal above filmstrip modal) -->
    <div id="cropModal" class="ib-overlay" style="display:none; z-index:1100;">
        <div class="ib-card crop-card">
            <div class="ib-header">
                <h3>Crop Image</h3>
                <button type="button" class="ib-close" id="cropCloseBtn" name="crop_close">&times;</button>
            </div>
            <div class="crop-body">
                <div class="crop-canvas-wrap">
                    <canvas id="cropCanvas"></canvas>
                </div>
                <div class="crop-info" id="cropInfo">1920 x 1080</div>
                <div class="crop-actions">
                    <button type="button" class="btn-primary" id="cropApplyBtn" name="crop_apply">Apply Crop</button>
                    <button type="button" class="btn-secondary" id="cropResetBtn" name="crop_reset">Reset</button>
                    <button type="button" class="btn-secondary" id="cropCancelBtn" name="crop_cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating image toolbar (positioned inside .ql-container) -->
    <div id="imgToolbar" class="img-toolbar" style="display:none;">
        <span class="img-tb-group">
            <button type="button" class="img-tb-btn" data-size="small" name="image_size_small">S</button>
            <button type="button" class="img-tb-btn" data-size="medium" name="image_size_medium">M</button>
            <button type="button" class="img-tb-btn" data-size="large" name="image_size_large">L</button>
        </span>
        <span class="img-tb-sep img-tb-sep-edit" style="display:none;"></span>
        <button type="button" class="img-tb-btn" id="imgTbEditBtn" name="image_edit" style="display:none;">Edit</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script>
    // Custom Image blot — preserves data-size, data-layout, width on <img>
    (function() {
        const BaseImage = Quill.import('formats/image');

        class CustomImage extends BaseImage {
            static create(value) {
                // Pass src string to base Image so it sets the src attribute
                const src = (typeof value === 'object' && value !== null) ? value.src : value;
                const node = super.create(src);
                if (typeof value === 'object' && value !== null) {
                    if (value['data-size']) node.setAttribute('data-size', value['data-size']);
                    if (value['data-layout']) node.setAttribute('data-layout', value['data-layout']);
                    if (value.width) node.style.width = value.width;
                }
                return node;
            }

            static value(node) {
                return {
                    src: node.getAttribute('src'),
                    alt: node.getAttribute('alt') || '',
                    'data-size': node.getAttribute('data-size') || '',
                    'data-layout': node.getAttribute('data-layout') || '',
                    width: node.style.width || ''
                };
            }

            static formats(node) {
                const fmt = {};
                if (node.getAttribute('data-size')) fmt['data-size'] = node.getAttribute('data-size');
                if (node.getAttribute('data-layout')) fmt['data-layout'] = node.getAttribute('data-layout');
                if (node.style.width) fmt.width = node.style.width;
                const alt = node.getAttribute('alt');
                if (alt) fmt.alt = alt;
                return fmt;
            }

            format(name, value) {
                if (name === 'data-size') {
                    if (value) this.domNode.setAttribute('data-size', value);
                    else this.domNode.removeAttribute('data-size');
                    // Also set width
                    const widths = { small: '33%', medium: '50%', large: '100%', full: '100%' };
                    this.domNode.style.width = widths[value] || '';
                } else if (name === 'data-layout') {
                    if (value) this.domNode.setAttribute('data-layout', value);
                    else this.domNode.removeAttribute('data-layout');
                } else if (name === 'width') {
                    if (value) this.domNode.style.width = value;
                    else this.domNode.style.width = '';
                } else {
                    super.format(name, value);
                }
            }
        }

        CustomImage.blotName = 'image';
        CustomImage.tagName = 'IMG';

        Quill.register(CustomImage, true);
    })();

    // Filmstrip BlockEmbed — single atomic block containing multiple images
    (function() {
        const BlockEmbed = Quill.import('blots/block/embed');

        class FilmstripBlot extends BlockEmbed {
            static create(value) {
                const node = super.create();
                node.setAttribute('contenteditable', 'false');
                const images = value.images || [];
                const size = value.size || 'medium';
                node.dataset.images = JSON.stringify(images);
                node.dataset.size = size;

                images.forEach(function(src) {
                    const img = document.createElement('img');
                    img.setAttribute('src', src);
                    img.setAttribute('draggable', 'false');
                    node.appendChild(img);
                });

                return node;
            }

            static value(node) {
                return {
                    images: JSON.parse(node.dataset.images || '[]'),
                    size: node.dataset.size || 'medium'
                };
            }
        }

        FilmstripBlot.blotName = 'filmstrip';
        FilmstripBlot.tagName = 'DIV';
        FilmstripBlot.className = 'img-filmstrip';

        Quill.register(FilmstripBlot, true);
    })();
    </script>
    <script src="{{ url_for('admin.static', filename='js/image-compress.js') }}"></script>
    <script>
    (function() {
        const API_BASE = '/admin/projects-editor/api/projects';
        const UPLOAD_URL = '/admin/projects-editor/upload-image';
        const LIST_URL = '/admin/projects-editor/list-images';
        const DELETE_URL = '/admin/projects-editor/delete-image';
        const TECH_REGISTRY_URL = '/admin/projects-editor/api/tech-registry';

        /* ── Tech autocomplete ── */
        const TECH_COLORS = {
            software: '#d4a855', hardware: '#4a9eff', marketing: '#ffa032',
            clients: '#e65064', equipment: '#b4b4c3', logistics: '#2ecc40',
            materials: '#64c8f0', services: '#1ad6ba', other: '#b164ff'
        };
        let techRegistry = [];          // [{name, category}, ...]
        let selectedTechs = [];         // [{name, category}, ...]
        let techDropdownIdx = -1;       // keyboard nav index

        async function loadTechRegistry() {
            try {
                const res = await fetch(TECH_REGISTRY_URL);
                techRegistry = await res.json();
            } catch (e) { console.error('Tech registry load failed', e); }
        }
        loadTechRegistry();

        const techSearchInput = document.getElementById('techSearchInput');
        const techDropdown = document.getElementById('techDropdown');
        const techTagsEl = document.getElementById('techTags');
        const techHidden = document.getElementById('technologies');
        const techWrap = document.getElementById('techInputWrap');
        const techCategoryPicker = document.getElementById('techCategoryPicker');
        const techCategorySelect = document.getElementById('techCategorySelect');
        let pendingTechName = '';

        function syncTechHidden() {
            techHidden.value = selectedTechs.map(t => t.name).join(', ');
        }

        function renderTechTags() {
            techTagsEl.innerHTML = selectedTechs.map((t, i) => {
                const c = TECH_COLORS[t.category] || TECH_COLORS.other;
                return `<span class="tech-pill" style="background:rgba(${hexToRgb(c)},0.15);color:${c};border:1px solid rgba(${hexToRgb(c)},0.3);">${escHtml(t.name)}<button type="button" class="tech-pill-x" name="tech_remove_${i}" data-idx="${i}">&times;</button></span>`;
            }).join('');
            techTagsEl.querySelectorAll('.tech-pill-x').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectedTechs.splice(+this.dataset.idx, 1);
                    renderTechTags();
                    syncTechHidden();
                });
            });
        }

        function hexToRgb(hex) {
            const h = hex.replace('#', '');
            return [parseInt(h.substring(0,2),16), parseInt(h.substring(2,4),16), parseInt(h.substring(4,6),16)].join(',');
        }

        function escHtml(s) {
            const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
        }

        function addTech(name, category) {
            const n = name.trim().toLowerCase();
            if (!n || selectedTechs.some(t => t.name === n)) return;
            selectedTechs.push({ name: n, category: category || 'other' });
            renderTechTags();
            syncTechHidden();
            techSearchInput.value = '';
            hideTechDropdown();
        }

        function showTechDropdown(items) {
            if (!items.length) { hideTechDropdown(); return; }
            techDropdownIdx = -1;
            techDropdown.innerHTML = items.map((t, i) => {
                const c = TECH_COLORS[t.category] || TECH_COLORS.other;
                return `<div class="tech-dropdown-item" data-idx="${i}"><span class="tech-dd-dot" style="background:${c};"></span>${escHtml(t.name)}<span class="tech-dd-cat">${t.category}</span></div>`;
            }).join('');
            techDropdown.style.display = 'block';
            techDropdown._items = items;
            techDropdown.querySelectorAll('.tech-dropdown-item').forEach(el => {
                el.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const idx = +this.dataset.idx;
                    addTech(techDropdown._items[idx].name, techDropdown._items[idx].category);
                });
            });
        }

        function hideTechDropdown() {
            techDropdown.style.display = 'none';
            techDropdown.innerHTML = '';
            techDropdownIdx = -1;
        }

        techSearchInput.addEventListener('input', function() {
            techCategoryPicker.style.display = 'none';
            const q = this.value.trim().toLowerCase();
            if (!q) { hideTechDropdown(); return; }
            const selectedNames = new Set(selectedTechs.map(t => t.name));
            const matches = techRegistry.filter(t => t.name.includes(q) && !selectedNames.has(t.name));
            showTechDropdown(matches.slice(0, 12));
        });

        techSearchInput.addEventListener('keydown', function(e) {
            const items = techDropdown._items || [];
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (items.length) {
                    techDropdownIdx = Math.min(techDropdownIdx + 1, items.length - 1);
                    highlightDropdownItem();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (items.length) {
                    techDropdownIdx = Math.max(techDropdownIdx - 1, 0);
                    highlightDropdownItem();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (techDropdownIdx >= 0 && items[techDropdownIdx]) {
                    addTech(items[techDropdownIdx].name, items[techDropdownIdx].category);
                } else {
                    const q = this.value.trim().toLowerCase();
                    if (!q) return;
                    const existing = techRegistry.find(t => t.name === q);
                    if (existing) {
                        addTech(existing.name, existing.category);
                    } else {
                        pendingTechName = q;
                        techCategoryPicker.style.display = 'flex';
                        techCategorySelect.focus();
                        hideTechDropdown();
                    }
                }
            } else if (e.key === 'Escape') {
                hideTechDropdown();
                techCategoryPicker.style.display = 'none';
            } else if (e.key === 'Backspace' && !this.value && selectedTechs.length) {
                selectedTechs.pop();
                renderTechTags();
                syncTechHidden();
            }
        });

        function highlightDropdownItem() {
            techDropdown.querySelectorAll('.tech-dropdown-item').forEach((el, i) => {
                el.classList.toggle('active', i === techDropdownIdx);
            });
        }

        techSearchInput.addEventListener('blur', function() {
            setTimeout(function() {
                if (!techWrap.contains(document.activeElement)) hideTechDropdown();
            }, 150);
        });

        techWrap.addEventListener('click', function(e) {
            if (!e.target.closest('.tech-category-picker') && !e.target.closest('.tech-pill-x')) {
                techSearchInput.focus();
            }
        });

        // Category picker — add new tech to registry
        document.getElementById('techCategoryAddBtn').addEventListener('click', async function() {
            if (!pendingTechName) return;
            const cat = techCategorySelect.value;
            try {
                await fetch(TECH_REGISTRY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: pendingTechName, category: cat })
                });
                techRegistry.push({ name: pendingTechName, category: cat });
                addTech(pendingTechName, cat);
            } catch (e) { alert('Failed to register tech: ' + e.message); }
            techCategoryPicker.style.display = 'none';
            pendingTechName = '';
        });

        document.getElementById('techCategoryCancelBtn').addEventListener('click', function() {
            techCategoryPicker.style.display = 'none';
            pendingTechName = '';
            techSearchInput.focus();
        });

        function setTechsFromString(str) {
            selectedTechs = [];
            if (!str) { renderTechTags(); syncTechHidden(); return; }
            str.split(',').forEach(s => {
                const n = s.trim().toLowerCase();
                if (!n) return;
                const reg = techRegistry.find(t => t.name === n);
                selectedTechs.push({ name: n, category: reg ? reg.category : 'other' });
            });
            renderTechTags();
            syncTechHidden();
        }

        // ===== Insights Picker =====
        let insightItems = []; // [{type, text}, ...]
        const insightsBody = document.getElementById('insightsBody');
        const insightsTable = document.getElementById('insightsTable');
        const insightsHidden = document.getElementById('insightsHidden');
        const insightTypeColors = { win: '#2ecc40', loss: '#ff2d95', takeaway: '#d4a855' };
        const insightTypeLabels = { win: 'Wins', loss: 'Losses', takeaway: 'Takeaways' };

        function syncInsightsHidden() {
            insightsHidden.value = insightItems.length ? JSON.stringify(insightItems) : '';
        }

        const insightTypeOrder = { win: 0, loss: 1, takeaway: 2 };

        function renderInsights() {
            // Sort: wins first, then losses, then takeaways
            insightItems.sort(function(a, b) {
                var oa = a.type in insightTypeOrder ? insightTypeOrder[a.type] : 9;
                var ob = b.type in insightTypeOrder ? insightTypeOrder[b.type] : 9;
                return oa - ob;
            });
            insightsTable.style.display = insightItems.length ? '' : 'none';
            insightsBody.innerHTML = insightItems.map(function(item, i) {
                var c = insightTypeColors[item.type] || '#aaa';
                return '<tr>' +
                    '<td style="width:28px;text-align:center;"><span class="insight-dot" style="background:' + c + ';"></span></td>' +
                    '<td style="width:80px;color:' + c + ';font-weight:600;font-size:0.8rem;">' + insightTypeLabels[item.type] + '</td>' +
                    '<td class="insight-text-cell" data-idx="' + i + '">' + item.text.replace(/</g, '&lt;') + '</td>' +
                    '<td style="width:100px;white-space:nowrap;"><button type="button" class="insight-edit" data-idx="' + i + '" name="insight_edit_' + i + '">Edit</button> <button type="button" class="insight-remove" data-idx="' + i + '" name="insight_remove_' + i + '">Remove</button></td>' +
                    '</tr>';
            }).join('');
            insightsBody.querySelectorAll('.insight-remove').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    insightItems.splice(+this.dataset.idx, 1);
                    renderInsights();
                    syncInsightsHidden();
                });
            });
            insightsBody.querySelectorAll('.insight-edit').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var idx = +this.dataset.idx;
                    var cell = insightsBody.querySelector('.insight-text-cell[data-idx="' + idx + '"]');
                    if (cell.querySelector('input')) return;
                    var original = insightItems[idx].text;
                    cell.innerHTML = '<input type="text" class="insight-inline-edit" value="' + original.replace(/"/g, '&quot;') + '">';
                    var inp = cell.querySelector('input');
                    inp.focus();
                    inp.selectionStart = inp.value.length;
                    function save() {
                        var val = inp.value.trim();
                        if (val) { insightItems[idx].text = val; }
                        renderInsights();
                        syncInsightsHidden();
                    }
                    inp.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') { e.preventDefault(); save(); }
                        if (e.key === 'Escape') { renderInsights(); }
                    });
                    inp.addEventListener('blur', save);
                });
            });
        }

        document.getElementById('insightAddBtn').addEventListener('click', function() {
            var text = document.getElementById('insightText').value.trim();
            if (!text) return;
            insightItems.push({ type: document.getElementById('insightType').value, text: text });
            document.getElementById('insightText').value = '';
            renderInsights();
            syncInsightsHidden();
        });

        document.getElementById('insightText').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('insightAddBtn').click(); }
        });

        function setInsightsFromJSON(json) {
            insightItems = [];
            if (!json) { renderInsights(); syncInsightsHidden(); return; }
            try { insightItems = JSON.parse(json); } catch (e) { insightItems = []; }
            renderInsights();
            syncInsightsHidden();
        }

        function clearInsights() {
            insightItems = [];
            renderInsights();
            syncInsightsHidden();
        }

        function clearTechs() {
            selectedTechs = [];
            techTagsEl.innerHTML = '';
            techHidden.value = '';
            techSearchInput.value = '';
            hideTechDropdown();
            techCategoryPicker.style.display = 'none';
        }

        // Register horizontal rule blot
        var BlockEmbed = Quill.import('blots/block/embed');
        class DividerBlot extends BlockEmbed {}
        DividerBlot.blotName = 'divider';
        DividerBlot.tagName = 'hr';
        Quill.register(DividerBlot);

        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Write project description...',
            modules: {
                toolbar: {
                    container: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['blockquote', 'code-block'],
                        ['link', 'image'],
                        ['divider'],
                        ['clean']
                    ],
                    handlers: {
                        'divider': function() {
                            var range = this.quill.getSelection(true);
                            this.quill.insertText(range.index, '\n', Quill.sources.USER);
                            this.quill.insertEmbed(range.index + 1, 'divider', true, Quill.sources.USER);
                            this.quill.setSelection(range.index + 2, Quill.sources.SILENT);
                        }
                    }
                }
            }
        });

        let editingId = null;
        let cachedProjects = []; // client-side cache for filtering

        loadProjects();

        // === Inline Image Toolbar (works for both images and filmstrip blots) ===
        (function() {
            const toolbar = document.getElementById('imgToolbar');
            const qlEditor = document.querySelector('.ql-editor');
            let activeEl = null;      // the img or .img-filmstrip div
            let activeIsFilmstrip = false;

            function positionToolbar(el) {
                const rect = el.getBoundingClientRect();
                const tbHeight = toolbar.offsetHeight;
                let top = rect.top - tbHeight - 8;
                if (top < 8) top = rect.bottom + 8;
                toolbar.style.top = top + 'px';
                toolbar.style.left = Math.max(8, rect.left) + 'px';
            }

            var editBtn = document.getElementById('imgTbEditBtn');
            var editSep = toolbar.querySelector('.img-tb-sep-edit');

            function showToolbar(el, isFilmstrip) {
                activeEl = el;
                activeIsFilmstrip = isFilmstrip;
                el.classList.add('img-selected');
                toolbar.style.display = 'flex';

                // Show/hide Edit button for filmstrips
                editBtn.style.display = isFilmstrip ? '' : 'none';
                editSep.style.display = isFilmstrip ? '' : 'none';

                // Highlight active size
                var curSize;
                if (isFilmstrip) {
                    curSize = el.dataset.size || 'medium';
                } else {
                    curSize = el.getAttribute('data-size') || 'large';
                }
                toolbar.querySelectorAll('.img-tb-btn[data-size]').forEach(function(btn) {
                    btn.classList.toggle('active', btn.dataset.size === curSize);
                });

                positionToolbar(el);
            }

            function hideToolbar() {
                toolbar.style.display = 'none';
                if (activeEl) activeEl.classList.remove('img-selected');
                activeEl = null;
                activeIsFilmstrip = false;
            }

            // Use mousedown on document
            document.addEventListener('mousedown', function(e) {
                // Check for filmstrip click (but not on the edit overlay button)
                var filmstrip = e.target.closest ? e.target.closest('.ql-editor .img-filmstrip') : null;
                if (filmstrip) {
                    setTimeout(function() {
                        if (activeEl && activeEl !== filmstrip) activeEl.classList.remove('img-selected');
                        showToolbar(filmstrip, true);
                    }, 0);
                    return;
                }

                // Check for regular image click
                var img = e.target.closest ? e.target.closest('.ql-editor img') : null;
                if (img && !img.closest('.img-filmstrip')) {
                    setTimeout(function() {
                        if (activeEl && activeEl !== img) activeEl.classList.remove('img-selected');
                        showToolbar(img, false);
                    }, 0);
                    return;
                }

                // Clicking on the toolbar itself — don't hide
                if (toolbar.contains(e.target)) return;
                if (activeEl) hideToolbar();
            });

            // Reposition on scroll
            qlEditor.addEventListener('scroll', function() {
                if (activeEl) positionToolbar(activeEl);
            });
            window.addEventListener('scroll', function() {
                if (activeEl) positionToolbar(activeEl);
            }, { passive: true });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') hideToolbar();
            });

            // Size buttons — works for both images and filmstrips
            toolbar.querySelectorAll('.img-tb-btn[data-size]').forEach(function(btn) {
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!activeEl) return;
                    var size = this.dataset.size;

                    if (activeIsFilmstrip) {
                        // Update filmstrip: delete and re-insert with new size
                        var blot = Quill.find(activeEl);
                        if (blot) {
                            var val = blot.constructor.value(activeEl);
                            var idx = blot.offset(blot.scroll);
                            quill.deleteText(idx, 1);
                            quill.insertEmbed(idx, 'filmstrip', { images: val.images, size: size }, Quill.sources.USER);
                            // Re-select the new filmstrip
                            setTimeout(function() {
                                var newFs = qlEditor.querySelector('.img-filmstrip.img-selected') ||
                                            qlEditor.querySelectorAll('.img-filmstrip')[0];
                                // Find the filmstrip at the same index
                                var allFs = qlEditor.querySelectorAll('.img-filmstrip');
                                for (var i = 0; i < allFs.length; i++) {
                                    if (allFs[i].dataset.size === size) {
                                        var b = Quill.find(allFs[i]);
                                        if (b && b.offset(b.scroll) === idx) {
                                            showToolbar(allFs[i], true);
                                            break;
                                        }
                                    }
                                }
                            }, 10);
                        }
                    } else {
                        // Regular image
                        var blot = Quill.find(activeEl);
                        if (blot) {
                            blot.format('data-size', size);
                        }
                        showToolbar(activeEl, false);
                    }
                });
            });

            // Edit button — opens filmstrip modal
            editBtn.addEventListener('mousedown', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (!activeEl || !activeIsFilmstrip) return;
                var blot = Quill.find(activeEl);
                if (blot && window._openFilmstripModal) {
                    var val = blot.constructor.value(activeEl);
                    var idx = blot.offset(blot.scroll);
                    hideToolbar();
                    window._openFilmstripModal(true, val.images, idx);
                }
            });
        })();

        // === Gallery State ===
        let galleryImages = [];
        let galleryLayout = 'single';

        function syncGalleryHidden() {
            document.getElementById('galleryImagesHidden').value = galleryImages.length ? JSON.stringify(galleryImages) : '';
            document.getElementById('imageUrl').value = galleryImages[0] || '';
        }

        function addGalleryImage(url) {
            if (!url || galleryImages.includes(url)) return;
            galleryImages.push(url);
            renderGalleryThumbs();
            syncGalleryHidden();
            updateFocalPreview();
        }

        function renderGalleryThumbs() {
            const container = document.getElementById('galleryThumbs');
            if (!galleryImages.length) { container.innerHTML = '<p class="gallery-empty">No images added yet</p>'; return; }
            container.innerHTML = galleryImages.map((url, i) => `
                <div class="gallery-thumb" draggable="true" data-idx="${i}">
                    <span class="gallery-thumb-num">${i + 1}</span>
                    <img src="${url}" alt="Gallery image ${i + 1}">
                    <button type="button" class="gallery-thumb-remove" name="gallery_remove_${i}" data-idx="${i}">&times;</button>
                </div>
            `).join('');

            // Remove buttons
            container.querySelectorAll('.gallery-thumb-remove').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    galleryImages.splice(+this.dataset.idx, 1);
                    renderGalleryThumbs();
                    syncGalleryHidden();
                    updateFocalPreview();
                });
            });

            // Drag-and-drop reorder
            let dragIdx = null;
            container.querySelectorAll('.gallery-thumb').forEach(thumb => {
                thumb.addEventListener('dragstart', function(e) {
                    dragIdx = +this.dataset.idx;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                thumb.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    dragIdx = null;
                });
                thumb.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    this.classList.add('drag-over');
                });
                thumb.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                thumb.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const dropIdx = +this.dataset.idx;
                    if (dragIdx === null || dragIdx === dropIdx) return;
                    const [moved] = galleryImages.splice(dragIdx, 1);
                    galleryImages.splice(dropIdx, 0, moved);
                    renderGalleryThumbs();
                    syncGalleryHidden();
                    updateFocalPreview();
                });
            });
        }

        // Focal point drag positioner (Facebook-style)
        let heroImageAlign = 'center 50%';
        let focalPercent = 50; // 0 = top, 100 = bottom
        const focalDragger = document.getElementById('focalDragger');
        const focalImg = document.getElementById('focalDraggerImg');
        const focalEmpty = document.getElementById('focalDraggerEmpty');
        const focalHint = document.getElementById('focalDraggerHint');

        function updateFocalPreview() {
            const src = galleryImages.length ? galleryImages[0] : '';
            if (src) {
                focalImg.src = src;
                focalImg.style.display = 'block';
                focalImg.style.objectPosition = `center ${focalPercent}%`;
                focalEmpty.style.display = 'none';
                focalHint.style.display = '';
            } else {
                focalImg.style.display = 'none';
                focalEmpty.style.display = '';
                focalHint.style.display = 'none';
            }
        }

        function setFocalPercent(pct) {
            focalPercent = Math.max(0, Math.min(100, pct));
            heroImageAlign = `center ${Math.round(focalPercent)}%`;
            document.getElementById('heroImageAlign').value = heroImageAlign;
            if (focalImg.style.display !== 'none') {
                focalImg.style.objectPosition = `center ${focalPercent}%`;
            }
        }

        // Drag handling
        (function() {
            let dragging = false, startY = 0, startPct = 0;

            function onStart(e) {
                if (focalImg.style.display === 'none') return;
                dragging = true;
                startY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
                startPct = focalPercent;
                focalDragger.classList.add('dragging');
                e.preventDefault();
            }
            function onMove(e) {
                if (!dragging) return;
                const clientY = e.type.startsWith('touch') ? e.touches[0].clientY : e.clientY;
                const deltaY = clientY - startY;
                // Dragging down = show higher part of image = lower percentage
                const containerH = focalDragger.offsetHeight;
                const pctDelta = -(deltaY / containerH) * 100;
                setFocalPercent(startPct + pctDelta);
            }
            function onEnd() {
                if (!dragging) return;
                dragging = false;
                focalDragger.classList.remove('dragging');
            }

            focalDragger.addEventListener('mousedown', onStart);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            focalDragger.addEventListener('touchstart', onStart, { passive: false });
            document.addEventListener('touchmove', onMove, { passive: true });
            document.addEventListener('touchend', onEnd);
        })();

        // Gallery layout picker
        document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                galleryLayout = this.dataset.layout;
                document.getElementById('galleryLayout').value = galleryLayout;
            });
        });

        // Add URL button
        document.getElementById('galleryAddUrlBtn').addEventListener('click', function() {
            const input = document.getElementById('galleryUrlInput');
            const url = input.value.trim();
            if (url) { addGalleryImage(url); input.value = ''; }
        });
        document.getElementById('galleryUrlInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('galleryAddUrlBtn').click(); }
        });

        // === Image Browser Modal ===
        const ibModal = document.getElementById('imageBrowserModal');
        const ibGrid = document.getElementById('ibGrid');
        const ibFooter = document.getElementById('ibFooter');
        let ibCurrentFolder = 'projects';
        let ibSelectCallback = null; // When set, Select button calls this instead of addGalleryImage
        let ibMultiSelect = false;   // When true, allow selecting multiple images
        let ibSelected = [];         // URLs selected in multi-select mode

        document.getElementById('browseImagesBtn').addEventListener('click', () => {
            ibModal.style.display = 'flex';
            loadBrowserImages(ibCurrentFolder);
        });

        function closeImageBrowser() {
            ibModal.style.display = 'none';
            ibSelectCallback = null;
            ibMultiSelect = false;
            ibSelected = [];
            ibFooter.style.display = 'none';
        }

        document.getElementById('ibCloseBtn').addEventListener('click', closeImageBrowser);

        ibModal.addEventListener('click', (e) => {
            if (e.target === ibModal) closeImageBrowser();
        });

        document.querySelectorAll('.ib-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.ib-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                ibCurrentFolder = this.dataset.folder;
                loadBrowserImages(ibCurrentFolder);
            });
        });

        function updateIbSelectedCount() {
            document.getElementById('ibSelectedCount').textContent = ibSelected.length + ' selected';
        }

        async function loadBrowserImages(folder) {
            ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.6;">Loading...</p>';
            try {
                const res = await fetch(`${LIST_URL}?folder=${folder}`);
                const images = await res.json();
                if (images.length === 0) {
                    ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.6;">No images in this folder.</p>';
                    return;
                }
                ibGrid.innerHTML = images.map(img => `
                    <div class="ib-item" data-url="${img.url}">
                        <img src="${img.url}" alt="${img.filename}" loading="lazy">
                        <span class="ib-filename">${img.filename}</span>
                        <div class="ib-actions">
                            <button type="button" class="ib-select-btn" name="image_browser_select" data-url="${img.url}">Select</button>
                            <button type="button" class="ib-delete-btn" name="image_browser_delete" data-url="${img.url}" title="Delete">&#128465;</button>
                        </div>
                    </div>
                `).join('');

                if (ibMultiSelect) {
                    // Multi-select: clicking the item toggles selection
                    ibGrid.querySelectorAll('.ib-item').forEach(item => {
                        if (ibSelected.includes(item.dataset.url)) item.classList.add('ib-selected');
                        item.addEventListener('click', function(e) {
                            if (e.target.closest('.ib-delete-btn')) return;
                            e.stopPropagation();
                            const url = this.dataset.url;
                            const idx = ibSelected.indexOf(url);
                            if (idx >= 0) {
                                ibSelected.splice(idx, 1);
                                this.classList.remove('ib-selected');
                            } else {
                                ibSelected.push(url);
                                this.classList.add('ib-selected');
                            }
                            updateIbSelectedCount();
                        });
                    });
                    // Hide per-item Select buttons in multi-select mode
                    ibGrid.querySelectorAll('.ib-select-btn').forEach(btn => btn.style.display = 'none');
                } else {
                    // Single-select: clicking Select picks one and closes
                    ibGrid.querySelectorAll('.ib-select-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const url = this.dataset.url;
                            if (ibSelectCallback) {
                                ibSelectCallback(url);
                            } else {
                                addGalleryImage(url);
                            }
                            closeImageBrowser();
                        });
                    });
                }

                ibGrid.querySelectorAll('.ib-delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        handleDeleteImage(this.dataset.url);
                    });
                });
            } catch (e) {
                ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#e74c3c;">Failed to load images.</p>';
            }
        }

        // Multi-select: "Add Selected" button
        document.getElementById('ibAddSelectedBtn').addEventListener('click', function() {
            if (ibSelectCallback && ibSelected.length) {
                ibSelectCallback(ibSelected.slice());
            }
            closeImageBrowser();
        });

        async function handleDeleteImage(url) {
            try {
                const res = await fetch(DELETE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();

                if (data.in_use) {
                    const refs = data.references.map(r => `- ${r.type}: ${r.title}`).join('\n');
                    if (!confirm(`This image is in use:\n${refs}\n\nDelete anyway?`)) return;
                    const res2 = await fetch(DELETE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, force: true })
                    });
                    const data2 = await res2.json();
                    if (!data2.success) { alert('Delete failed: ' + (data2.error || 'Unknown error')); return; }
                } else if (!data.success) {
                    alert('Delete failed: ' + (data.error || 'Unknown error'));
                    return;
                }

                const item = ibGrid.querySelector(`.ib-item[data-url="${CSS.escape(url)}"]`);
                if (item) item.remove();
                if (!ibGrid.querySelector('.ib-item')) {
                    ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.6;">No images in this folder.</p>';
                }
            } catch (e) {
                alert('Delete error: ' + e.message);
            }
        }

        // Image upload → adds to gallery
        document.getElementById('imageFile')?.addEventListener('change', async function() {
            if (!this.files[0]) return;
            const compressed = typeof compressImageFile === 'function' ? await compressImageFile(this.files[0]) : this.files[0];
            const formData = new FormData();
            formData.append('image', compressed);
            const progress = document.getElementById('uploadProgress');
            progress.style.display = 'block';
            try {
                const res = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    addGalleryImage(data.image_url);
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) { alert('Upload error: ' + e.message); }
            finally { progress.style.display = 'none'; this.value = ''; }
        });

        // Save buttons
        document.getElementById('publishBtn').addEventListener('click', () => saveProject('published'));
        document.getElementById('draftBtn').addEventListener('click', () => saveProject('draft'));
        document.getElementById('cancelBtn').addEventListener('click', resetForm);

        async function loadProjects() {
            try {
                const res = await fetch(API_BASE);
                cachedProjects = await res.json();
                renderProjects(cachedProjects);
            } catch (e) { console.error('Error loading projects:', e); }
        }

        function renderProjects(projects) {
            const container = document.getElementById('projectsList');
            const search = document.getElementById('projectSearch').value.toLowerCase();
            const filter = document.getElementById('projectFilter').value;

            let filtered = projects.filter(p => {
                if (filter !== 'all' && p.status !== filter) return false;
                if (search && !p.title.toLowerCase().includes(search)) return false;
                return true;
            });

            document.getElementById('projectCount').textContent = `${filtered.length} project${filtered.length !== 1 ? 's' : ''}`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No projects found</p></div>';
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="article-card" data-id="${p.id}">
                    <div class="article-card-header">
                        <h3 class="article-title">${p.title}</h3>
                        <div>
                            <span class="status-badge status-${p.status}">${p.status}</span>
                            <span class="status-badge ps-${p.project_status}">${p.project_status}</span>
                        </div>
                    </div>
                    <div class="article-meta">
                        ${p.year ? `<span>Year: ${p.year}</span>` : ''}
                        ${p.technologies ? `<span>Tech: ${p.technologies}</span>` : ''}
                        <span>Updated: ${new Date(p.updated_at).toLocaleDateString()}</span>
                    </div>
                    <div class="article-actions">
                        <button class="btn-small btn-edit" name="project_edit_${p.id}" onclick="window._editProject(${p.id})">Edit</button>
                        <button class="btn-small btn-toggle-publish" name="project_toggle_publish_${p.id}" onclick="window._togglePublish(${p.id})">
                            ${p.status === 'published' ? 'Unpublish' : 'Publish'}
                        </button>
                        <select class="btn-small btn-toggle" name="project_status_${p.id}" onchange="window._setProjectStatus(${p.id}, this.value)" style="cursor:pointer;">
                            ${['active','paused','retired','limited','one-off','experiment','academic'].map(s =>
                                `<option value="${s}"${s === (p.project_status || 'active') ? ' selected' : ''}>${s.replace('-',' ').replace(/\\b\\w/g,c=>c.toUpperCase())}</option>`
                            ).join('')}
                        </select>
                        <button class="btn-small btn-delete" name="project_delete_${p.id}" onclick="window._deleteProject(${p.id})">Delete</button>
                        ${p.status === 'published' ? `<button class="btn-small email-btn" name="send_project_email_${p.id}" onclick="window._sendProjectEmail(${p.id})">${p.email_sent ? 'Resend Email' : 'Send Email'}</button>` : ''}
                        ${p.status === 'published' ? `<div class="share-dropdown" style="display:inline-block;position:relative;">
                            <button class="btn-small share-btn" onclick="this.nextElementSibling.classList.toggle('show')">Share ▾</button>
                            <div class="share-menu">
                                <div class="share-item" onclick="window._crosspostProject(${p.id},'linkedin')">${p.crossposted_linkedin ? '✓ ' : ''}LinkedIn</div>
                                <div class="share-item" onclick="window._crosspostProject(${p.id},'medium')">${p.crossposted_medium ? '✓ ' : '✉ '}Medium (Request API)</div>
                                <div class="share-item" onclick="window._crosspostProject(${p.id},'substack')">${p.crossposted_substack ? '✓ ' : ''}Substack</div>
                                <div class="share-item" onclick="window._crosspostProject(${p.id},'twitter')">${p.crossposted_twitter ? '✓ ' : ''}Twitter/X</div>
                                <div class="share-item" onclick="window._crosspostProject(${p.id},'threads')">${p.crossposted_threads ? '✓ ' : ''}Threads</div>
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('projectSearch').addEventListener('input', () => renderProjects(cachedProjects));
        document.getElementById('projectFilter').addEventListener('change', () => renderProjects(cachedProjects));

        async function fetchExternalContent() {
            const url = document.getElementById('externalUrl').value.trim();
            if (!url) { alert('Enter an External URL first'); return; }
            const statusEl = document.getElementById('fetchStatus');
            const btn = document.getElementById('fetchExternalBtn');
            statusEl.textContent = 'Fetching...';
            statusEl.style.color = '';
            btn.disabled = true;
            try {
                const res = await fetch(API_BASE + '/fetch-external', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url})
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('fetchedExternalContent').value = data.html;
                    const sizeKb = (new Blob([data.html]).size / 1024).toFixed(1);
                    statusEl.textContent = 'Content fetched (' + sizeKb + 'kb)';
                    statusEl.style.color = 'green';
                } else {
                    statusEl.textContent = data.error || 'Fetch failed';
                    statusEl.style.color = 'red';
                }
            } catch (e) {
                statusEl.textContent = 'Error: ' + e.message;
                statusEl.style.color = 'red';
            } finally {
                btn.disabled = false;
            }
        }
        window.fetchExternalContent = fetchExternalContent;

        async function saveProject(status) {
            const title = document.getElementById('title').value.trim();
            const quillContent = quill.root.innerHTML;
            const hasExternalUrl = document.getElementById('externalUrl').value.trim();
            const fetchedContent = document.getElementById('fetchedExternalContent').value;
            const content = (hasExternalUrl && fetchedContent) ? fetchedContent : quillContent;
            if (!title) { alert('Title is required'); return; }
            if (!hasExternalUrl && (!quillContent || quillContent === '<p><br></p>')) { alert('Content is required (or set an External URL)'); return; }

            syncGalleryHidden();
            const body = {
                title, content,
                image_url: document.getElementById('imageUrl').value.trim(),
                year: document.getElementById('year').value || null,
                year_end: document.getElementById('yearEnd').value || null,
                status: status,
                project_status: document.getElementById('projectStatus').value,
                technologies: document.getElementById('technologies').value.trim() || null,
                excerpt: document.getElementById('excerpt').value.trim() || null,
                meta_description: document.getElementById('metaDescription').value.trim() || null,
                gross_earnings: document.getElementById('grossEarnings').value || null,
                earnings_currency: document.getElementById('earningsCurrency').value || null,
                earnings_label: document.getElementById('earningsLabel').value || null,
                gallery_images: document.getElementById('galleryImagesHidden').value || null,
                gallery_layout: document.getElementById('galleryLayout').value || 'single',
                hero_image_align: document.getElementById('heroImageAlign').value || 'center center',
                insights: document.getElementById('insightsHidden').value || null,
                external_url: document.getElementById('externalUrl').value.trim() || null
            };

            try {
                const wasEditing = !!editingId;
                const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
                const method = editingId ? 'PUT' : 'POST';
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success || data.id) {
                    loadProjects();
                    if (wasEditing) {
                        // Stay in editor — just flash a confirmation and update status
                        var flash = document.getElementById('saveFlash');
                        flash.textContent = 'Saved';
                        flash.style.display = 'inline';
                        flash.classList.remove('flash-fade');
                        void flash.offsetWidth;
                        flash.classList.add('flash-fade');
                        document.getElementById('currentStatus').textContent = status;
                    } else {
                        // New project — switch into edit mode for it
                        var newId = data.id;
                        resetForm();
                        if (newId) window._editProject(newId);
                    }
                }
                else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error saving project: ' + e.message); }
        }

        window._editProject = async function(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}`);
                const p = await res.json();
                editingId = id;
                document.getElementById('projectId').value = id;
                document.getElementById('title').value = p.title || '';
                document.getElementById('year').value = p.year || '';
                document.getElementById('yearEnd').value = p.year_end || '';
                document.getElementById('projectStatus').value = p.project_status || 'active';
                setTechsFromString(p.technologies || '');
                // Load gallery state (backward compat: legacy image_url → 1-item gallery)
                if (p.gallery_images) {
                    try { galleryImages = JSON.parse(p.gallery_images); } catch (e) { galleryImages = []; }
                } else if (p.image_url) {
                    galleryImages = [p.image_url];
                } else {
                    galleryImages = [];
                }
                galleryLayout = p.gallery_layout || 'single';
                document.getElementById('galleryLayout').value = galleryLayout;
                document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.layout === galleryLayout);
                });
                renderGalleryThumbs();
                syncGalleryHidden();

                // Restore focal point — parse percentage from stored value
                heroImageAlign = p.hero_image_align || 'center 50%';
                document.getElementById('heroImageAlign').value = heroImageAlign;
                const pctMatch = heroImageAlign.match(/(\d+)%/);
                if (pctMatch) {
                    focalPercent = parseInt(pctMatch[1], 10);
                } else if (heroImageAlign.includes('top')) {
                    focalPercent = 0;
                } else if (heroImageAlign.includes('bottom')) {
                    focalPercent = 100;
                } else {
                    focalPercent = 50;
                }
                updateFocalPreview();

                document.getElementById('excerpt').value = p.excerpt || '';
                document.getElementById('metaDescription').value = p.meta_description || '';
                document.getElementById('grossEarnings').value = p.gross_earnings || '';
                document.getElementById('earningsCurrency').value = p.earnings_currency || '£';
                document.getElementById('earningsLabel').value = p.earnings_label || '';
                setInsightsFromJSON(p.insights || '');
                document.getElementById('externalUrl').value = p.external_url || '';
                if (p.external_url && p.content) {
                    document.getElementById('fetchedExternalContent').value = p.content;
                    const sizeKb = (new Blob([p.content]).size / 1024).toFixed(1);
                    document.getElementById('fetchStatus').textContent = 'Content fetched (' + sizeKb + 'kb)';
                    document.getElementById('fetchStatus').style.color = 'green';
                } else {
                    document.getElementById('fetchedExternalContent').value = '';
                    document.getElementById('fetchStatus').textContent = '';
                }
                quill.root.innerHTML = p.content || '';

                document.getElementById('formTitle').textContent = 'Edit Project';
                document.getElementById('publishBtn').textContent = 'Update & Publish';
                document.getElementById('draftBtn').textContent = 'Update as Draft';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                document.getElementById('statusIndicator').style.display = 'block';
                document.getElementById('currentStatus').textContent = p.status;
                document.getElementById('currentProjectStatus').textContent = p.project_status;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { alert('Error loading project: ' + e.message); }
        };

        window._togglePublish = async function(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}/toggle-publish`, { method: 'POST' });
                const data = await res.json();
                if (data.success) loadProjects(); else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window._setProjectStatus = async function(id, status) {
            try {
                const res = await fetch(`${API_BASE}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({project_status: status})
                });
                const data = await res.json();
                if (data.success) loadProjects(); else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window._deleteProject = async function(id) {
            if (!confirm('Delete this project?')) return;
            try {
                const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) loadProjects(); else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window._sendProjectEmail = async function(id) {
            if (!confirm('Send this project to all subscribers via email?')) return;
            const btn = document.querySelector(`button[onclick="window._sendProjectEmail(${id})"]`);
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                const res = await fetch(`${API_BASE}/${id}/send-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    alert(`Email sent to ${data.subscriber_count} subscribers!`);
                    loadProjects();
                } else {
                    alert(data.message || data.error || 'Failed to send email');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        window._crosspostProject = async function(id, platform) {
            // Close any open dropdown
            document.querySelectorAll('.share-menu.show').forEach(m => m.classList.remove('show'));

            // Medium: no API available — open email to request access
            if (platform === 'medium') {
                const subject = encodeURIComponent('API Integration Token Request — Programmatic Publishing');
                const body = encodeURIComponent(
                    'Hi Medium team,\n\n' +
                    'I run a personal blog at https://laurence.computer and would like to cross-post my articles to Medium programmatically.\n\n' +
                    'I understand that new integration tokens are no longer available through the settings page. ' +
                    'Is there any way to request an API integration token for publishing articles via the Medium API?\n\n' +
                    'I would use it solely for posting my own original content with canonical URLs pointing back to my site.\n\n' +
                    'Thanks for your time.\n\nBest,\nLaurence'
                );
                window.open(`mailto:yourfriends@medium.com?subject=${subject}&body=${body}`, '_blank');
                return;
            }

            if (!confirm(`Share this project to ${platform.charAt(0).toUpperCase() + platform.slice(1)}?`)) return;
            try {
                const res = await fetch(`${API_BASE}/${id}/crosspost/${platform}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    let msg = `Posted to ${platform.charAt(0).toUpperCase() + platform.slice(1)}!`;
                    if (data.url) msg += `\n\nURL: ${data.url}`;
                    alert(msg);
                    loadProjects();
                } else {
                    alert(data.error || `Failed to post to ${platform}`);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        // Close share dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.share-dropdown')) {
                document.querySelectorAll('.share-menu.show').forEach(m => m.classList.remove('show'));
            }
        });

        // === Filmstrip Modal ===
        (function() {
            let fsImages = [];       // [{url, cropped}]
            let fsEditMode = false;  // true when editing existing filmstrip
            let fsEditIndex = 0;     // Quill index of first image in group being edited
            let fsSavedRange = null; // cursor position when modal opened

            const fsModal = document.getElementById('filmstripModal');
            const fsPreview = document.getElementById('fsPreview');
            const fsEmpty = document.getElementById('fsEmpty');
            const fsModalTitle = document.getElementById('fsModalTitle');

            // --- Render preview strip ---
            function renderFsPreview() {
                if (!fsImages.length) {
                    fsPreview.innerHTML = '<p class="fs-empty">No images added yet — upload, browse, or paste a URL below.</p>';
                    return;
                }
                fsPreview.innerHTML = fsImages.map((img, i) => `
                    <div class="fs-thumb" draggable="true" data-idx="${i}">
                        <img src="${img.url}" alt="Filmstrip image ${i + 1}">
                        <div class="fs-thumb-actions">
                            <button type="button" class="fs-crop-btn" name="filmstrip_crop_${i}" data-idx="${i}" title="Crop">&#9986;</button>
                            <button type="button" class="fs-remove-btn" name="filmstrip_remove_${i}" data-idx="${i}" title="Remove">&times;</button>
                        </div>
                        ${img.cropped ? '<span class="fs-crop-badge">Cropped</span>' : ''}
                    </div>
                `).join('');

                // Remove buttons
                fsPreview.querySelectorAll('.fs-remove-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        fsImages.splice(+this.dataset.idx, 1);
                        renderFsPreview();
                    });
                });

                // Crop buttons
                fsPreview.querySelectorAll('.fs-crop-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        openCropModal(+this.dataset.idx);
                    });
                });

                // Drag-to-reorder
                let dragIdx = null;
                fsPreview.querySelectorAll('.fs-thumb').forEach(thumb => {
                    thumb.addEventListener('dragstart', function(e) {
                        dragIdx = +this.dataset.idx;
                        this.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    thumb.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                        dragIdx = null;
                    });
                    thumb.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        this.classList.add('drag-over');
                    });
                    thumb.addEventListener('dragleave', function() {
                        this.classList.remove('drag-over');
                    });
                    thumb.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('drag-over');
                        const dropIdx = +this.dataset.idx;
                        if (dragIdx === null || dragIdx === dropIdx) return;
                        const [moved] = fsImages.splice(dragIdx, 1);
                        fsImages.splice(dropIdx, 0, moved);
                        renderFsPreview();
                    });
                });
            }

            // --- Add image to filmstrip ---
            function addFsImage(url) {
                if (!url || fsImages.some(img => img.url === url)) return;
                fsImages.push({ url: url, cropped: false });
                renderFsPreview();
            }

            // --- File upload ---
            document.getElementById('fsFileInput').addEventListener('change', async function() {
                const files = Array.from(this.files);
                if (!files.length) return;
                const progress = document.getElementById('fsUploadProgress');
                const progressText = document.getElementById('fsProgressText');
                progress.style.display = 'block';
                for (let i = 0; i < files.length; i++) {
                    progressText.textContent = `Uploading ${i + 1}/${files.length}...`;
                    try {
                        const compressed = typeof compressImageFile === 'function' ? await compressImageFile(files[i]) : files[i];
                        const formData = new FormData();
                        formData.append('image', compressed);
                        const res = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
                        const data = await res.json();
                        if (data.success) addFsImage(data.image_url);
                    } catch (e) { console.error('Upload error:', e); }
                }
                progress.style.display = 'none';
                this.value = '';
            });

            // --- Browse library ---
            document.getElementById('fsBrowseBtn').addEventListener('click', function() {
                ibMultiSelect = true;
                ibSelected = [];
                ibSelectCallback = function(urls) {
                    urls.forEach(function(url) { addFsImage(url); });
                };
                ibFooter.style.display = 'flex';
                updateIbSelectedCount();
                ibModal.style.display = 'flex';
                loadBrowserImages(ibCurrentFolder);
            });

            // --- URL paste ---
            document.getElementById('fsAddUrlBtn').addEventListener('click', function() {
                const input = document.getElementById('fsUrlInput');
                const url = input.value.trim();
                if (url) { addFsImage(url); input.value = ''; }
            });
            document.getElementById('fsUrlInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { e.preventDefault(); document.getElementById('fsAddUrlBtn').click(); }
            });

            // --- Open filmstrip modal ---
            function openFilmstripModal(editMode, images, editIndex) {
                fsEditMode = !!editMode;
                fsEditIndex = editIndex || 0;
                fsImages = images ? images.map(url => ({ url: url, cropped: false })) : [];
                fsSavedRange = quill.getSelection();
                fsModalTitle.textContent = fsEditMode ? 'Edit Filmstrip' : 'Insert Filmstrip';
                document.getElementById('fsInsertBtn').textContent = fsEditMode ? 'Update Filmstrip' : 'Insert Filmstrip';
                renderFsPreview();
                fsModal.style.display = 'flex';
            }
            // Expose globally for FilmstripBlot edit overlay
            window._openFilmstripModal = openFilmstripModal;

            // --- Close ---
            document.getElementById('fsCloseBtn').addEventListener('click', () => { fsModal.style.display = 'none'; });
            document.getElementById('fsCancelBtn').addEventListener('click', () => { fsModal.style.display = 'none'; });
            fsModal.addEventListener('click', (e) => { if (e.target === fsModal) fsModal.style.display = 'none'; });

            // --- Helper: insert filmstrip as single BlockEmbed ---
            function insertFilmstripIntoQuill(startIdx, images) {
                const urls = images.map(img => img.url);
                quill.insertEmbed(startIdx, 'filmstrip', { images: urls }, Quill.sources.USER);
            }

            // --- Insert / Update filmstrip ---
            document.getElementById('fsInsertBtn').addEventListener('click', function() {
                if (!fsImages.length) { fsModal.style.display = 'none'; return; }

                if (fsEditMode) {
                    // Delete the old filmstrip blot at fsEditIndex, insert new one
                    quill.deleteText(fsEditIndex, 1);
                    insertFilmstripIntoQuill(fsEditIndex, fsImages);
                } else {
                    const insertIdx = fsSavedRange ? fsSavedRange.index : quill.getLength() - 1;
                    insertFilmstripIntoQuill(insertIdx, fsImages);
                }

                fsModal.style.display = 'none';
            });

            // --- Quill toolbar: filmstrip button (manually created) ---
            (function() {
                const toolbarEl = document.querySelector('.ql-toolbar');
                if (!toolbarEl) return;
                // Find the group containing the image button and append after it
                const imgBtn = toolbarEl.querySelector('.ql-image');
                const group = imgBtn ? imgBtn.closest('.ql-formats') : toolbarEl.querySelector('.ql-formats:last-child');
                if (!group) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'ql-filmstrip';
                btn.title = 'Insert Filmstrip';
                btn.innerHTML = '<svg viewBox="0 0 18 18" width="18" height="18"><rect x="1" y="4" width="4" height="10" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.2"/><rect x="7" y="4" width="4" height="10" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.2"/><rect x="13" y="4" width="4" height="10" rx="0.5" fill="none" stroke="currentColor" stroke-width="1.2"/></svg>';
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openFilmstripModal(false, null, 0);
                });
                group.appendChild(btn);
            })();

            // Edit filmstrip is handled by the blot's built-in edit overlay button

            // === Crop Modal ===
            const cropModal = document.getElementById('cropModal');
            const cropCanvas = document.getElementById('cropCanvas');
            const cropCtx = cropCanvas.getContext('2d');
            const cropInfo = document.getElementById('cropInfo');
            let cropImg = null;
            let cropIdx = -1;
            let cropRect = { x: 0, y: 0, w: 0, h: 0 }; // in image pixels
            let imgW = 0, imgH = 0;
            let canvasDisplayW = 0, canvasDisplayH = 0;
            let cropDragging = null; // null | 'left' | 'right' | 'top' | 'bottom' | 'tl' | 'tr' | 'bl' | 'br'

            function openCropModal(idx) {
                cropIdx = idx;
                cropImg = new Image();
                cropImg.onload = function() {
                    imgW = cropImg.naturalWidth;
                    imgH = cropImg.naturalHeight;
                    cropRect = { x: 0, y: 0, w: imgW, h: imgH };
                    sizeCropCanvas();
                    drawCrop();
                    cropModal.style.display = 'flex';
                };
                cropImg.onerror = function() {
                    // Retry without crossOrigin if it fails
                    if (cropImg.crossOrigin) {
                        cropImg.crossOrigin = '';
                        cropImg.src = fsImages[idx].url;
                    } else {
                        alert('Could not load image for cropping.');
                    }
                };
                cropImg.src = fsImages[idx].url;
            }

            function sizeCropCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const maxW = Math.min(700, window.innerWidth - 80);
                const maxH = Math.min(500, window.innerHeight - 200);
                const scale = Math.min(maxW / imgW, maxH / imgH, 1);
                canvasDisplayW = Math.round(imgW * scale);
                canvasDisplayH = Math.round(imgH * scale);
                cropCanvas.style.width = canvasDisplayW + 'px';
                cropCanvas.style.height = canvasDisplayH + 'px';
                cropCanvas.width = canvasDisplayW * dpr;
                cropCanvas.height = canvasDisplayH * dpr;
                cropCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }

            function drawCrop() {
                const scaleX = canvasDisplayW / imgW;
                const scaleY = canvasDisplayH / imgH;

                // Draw full image dimmed
                cropCtx.clearRect(0, 0, canvasDisplayW, canvasDisplayH);
                cropCtx.globalAlpha = 0.3;
                cropCtx.drawImage(cropImg, 0, 0, canvasDisplayW, canvasDisplayH);

                // Draw crop region bright
                const cx = cropRect.x * scaleX;
                const cy = cropRect.y * scaleY;
                const cw = cropRect.w * scaleX;
                const ch = cropRect.h * scaleY;

                cropCtx.globalAlpha = 1;
                cropCtx.save();
                cropCtx.beginPath();
                cropCtx.rect(cx, cy, cw, ch);
                cropCtx.clip();
                cropCtx.drawImage(cropImg, 0, 0, canvasDisplayW, canvasDisplayH);
                cropCtx.restore();

                // White border on crop edges
                cropCtx.strokeStyle = '#fff';
                cropCtx.lineWidth = 1.5;
                cropCtx.strokeRect(cx, cy, cw, ch);

                // Corner handles
                const hs = 8;
                cropCtx.fillStyle = '#fff';
                [[cx, cy], [cx + cw, cy], [cx, cy + ch], [cx + cw, cy + ch]].forEach(([hx, hy]) => {
                    cropCtx.fillRect(hx - hs/2, hy - hs/2, hs, hs);
                });

                // Update info
                cropInfo.textContent = `${Math.round(cropRect.w)} x ${Math.round(cropRect.h)}`;
            }

            // Edge detection
            function detectEdge(mx, my) {
                const scaleX = canvasDisplayW / imgW;
                const scaleY = canvasDisplayH / imgH;
                const cx = cropRect.x * scaleX, cy = cropRect.y * scaleY;
                const cw = cropRect.w * scaleX, ch = cropRect.h * scaleY;
                const t = 12; // threshold

                const nearL = Math.abs(mx - cx) < t;
                const nearR = Math.abs(mx - (cx + cw)) < t;
                const nearT = Math.abs(my - cy) < t;
                const nearB = Math.abs(my - (cy + ch)) < t;

                if (nearT && nearL) return 'tl';
                if (nearT && nearR) return 'tr';
                if (nearB && nearL) return 'bl';
                if (nearB && nearR) return 'br';
                if (nearL && my > cy && my < cy + ch) return 'left';
                if (nearR && my > cy && my < cy + ch) return 'right';
                if (nearT && mx > cx && mx < cx + cw) return 'top';
                if (nearB && mx > cx && mx < cx + cw) return 'bottom';
                return null;
            }

            let cropStartRect = null, cropStartPos = null;

            function getCanvasPos(e) {
                const rect = cropCanvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            function onCropStart(e) {
                const pos = getCanvasPos(e);
                const edge = detectEdge(pos.x, pos.y);
                if (!edge) return;
                e.preventDefault();
                cropDragging = edge;
                cropStartRect = { ...cropRect };
                cropStartPos = pos;
                cropCanvas.style.cursor = getCropCursor(edge);
            }

            function onCropMove(e) {
                if (!cropDragging) {
                    // Only update cursor when hovering over canvas
                    if (e.target !== cropCanvas) return;
                    const pos = getCanvasPos(e);
                    const edge = detectEdge(pos.x, pos.y);
                    cropCanvas.style.cursor = edge ? getCropCursor(edge) : 'default';
                    return;
                }
                e.preventDefault();
                const pos = getCanvasPos(e);
                const dx = (pos.x - cropStartPos.x) / (canvasDisplayW / imgW);
                const dy = (pos.y - cropStartPos.y) / (canvasDisplayH / imgH);

                const r = { ...cropStartRect };
                const minSize = 20;

                const moveL = cropDragging === 'left' || cropDragging === 'tl' || cropDragging === 'bl';
                const moveR = cropDragging === 'right' || cropDragging === 'tr' || cropDragging === 'br';
                const moveT = cropDragging === 'top' || cropDragging === 'tl' || cropDragging === 'tr';
                const moveB = cropDragging === 'bottom' || cropDragging === 'bl' || cropDragging === 'br';

                if (moveL) {
                    const newX = Math.max(0, Math.min(r.x + dx, r.x + r.w - minSize));
                    r.w -= (newX - r.x);
                    r.x = newX;
                }
                if (moveR) {
                    r.w = Math.max(minSize, Math.min(r.w + dx, imgW - r.x));
                }
                if (moveT) {
                    const newY = Math.max(0, Math.min(r.y + dy, r.y + r.h - minSize));
                    r.h -= (newY - r.y);
                    r.y = newY;
                }
                if (moveB) {
                    r.h = Math.max(minSize, Math.min(r.h + dy, imgH - r.y));
                }

                cropRect = r;
                drawCrop();
            }

            function onCropEnd() {
                cropDragging = null;
                cropCanvas.style.cursor = 'default';
            }

            function getCropCursor(edge) {
                const map = { tl: 'nwse-resize', br: 'nwse-resize', tr: 'nesw-resize', bl: 'nesw-resize',
                              left: 'ew-resize', right: 'ew-resize', top: 'ns-resize', bottom: 'ns-resize' };
                return map[edge] || 'default';
            }

            cropCanvas.addEventListener('mousedown', onCropStart);
            document.addEventListener('mousemove', onCropMove);
            document.addEventListener('mouseup', onCropEnd);
            cropCanvas.addEventListener('touchstart', onCropStart, { passive: false });
            document.addEventListener('touchmove', onCropMove, { passive: false });
            document.addEventListener('touchend', onCropEnd);

            // Apply crop — server-side (avoids CORS canvas taint)
            const CROP_URL = '/admin/projects-editor/crop-image';
            document.getElementById('cropApplyBtn').addEventListener('click', async function() {
                if (cropIdx < 0 || !cropImg) return;
                this.disabled = true;
                this.textContent = 'Applying...';
                try {
                    const res = await fetch(CROP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: fsImages[cropIdx].url,
                            x: Math.round(cropRect.x),
                            y: Math.round(cropRect.y),
                            w: Math.round(cropRect.w),
                            h: Math.round(cropRect.h)
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        fsImages[cropIdx] = { url: data.image_url, cropped: true };
                        renderFsPreview();
                    } else {
                        alert('Crop failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Crop error: ' + e.message);
                }
                this.disabled = false;
                this.textContent = 'Apply Crop';
                cropModal.style.display = 'none';
            });

            // Reset crop
            document.getElementById('cropResetBtn').addEventListener('click', function() {
                cropRect = { x: 0, y: 0, w: imgW, h: imgH };
                drawCrop();
            });

            // Cancel/close crop
            document.getElementById('cropCancelBtn').addEventListener('click', () => { cropModal.style.display = 'none'; });
            document.getElementById('cropCloseBtn').addEventListener('click', () => { cropModal.style.display = 'none'; });
            cropModal.addEventListener('click', (e) => { if (e.target === cropModal) cropModal.style.display = 'none'; });

            // Expose openFilmstripModal for toolbar button
            window._openFilmstripModal = openFilmstripModal;
        })();

        function resetForm() {
            editingId = null;
            document.getElementById('projectId').value = '';
            document.getElementById('title').value = '';
            document.getElementById('year').value = '';
            document.getElementById('yearEnd').value = '';
            document.getElementById('projectStatus').value = 'active';
            clearTechs();
            clearInsights();
            galleryImages = [];
            galleryLayout = 'single';
            document.getElementById('galleryLayout').value = 'single';
            document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(b => b.classList.toggle('active', b.dataset.layout === 'single'));
            heroImageAlign = 'center 50%';
            focalPercent = 50;
            document.getElementById('heroImageAlign').value = 'center 50%';
            updateFocalPreview();
            renderGalleryThumbs();
            syncGalleryHidden();
            document.getElementById('imageFile').value = '';
            document.getElementById('galleryUrlInput').value = '';
            document.getElementById('excerpt').value = '';
            document.getElementById('metaDescription').value = '';
            document.getElementById('grossEarnings').value = '';
            document.getElementById('earningsCurrency').value = '£';
            document.getElementById('externalUrl').value = '';
            document.getElementById('fetchedExternalContent').value = '';
            document.getElementById('fetchStatus').textContent = '';
            quill.root.innerHTML = '';
            document.getElementById('formTitle').textContent = 'Create New Project';
            document.getElementById('publishBtn').textContent = 'Publish Project';
            document.getElementById('draftBtn').textContent = 'Save as Draft';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('statusIndicator').style.display = 'none';
        }
    })();
    </script>

    <style>
    .form-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--noir-gray); }
    .form-section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--noir-silver); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
    #excerpt, #metaDescription { min-height: 60px; resize: vertical; }
    .status-badge { display: inline-block; min-width: 72px; text-align: center; }
    .status-published { background: #2ecc40; color: #fff; }
    .status-draft { background: #f0ad4e; color: #fff; }
    .ps-active { background: #2ecc40; color: #fff; }
    .ps-paused { background: #f0b429; color: #fff; }
    .ps-retired { background: #e74c3c; color: #fff; }
    .ps-limited { background: #b24dff; color: #fff; }
    .ps-one-off { background: #2dd4bf; color: #fff; }
    .ps-experiment { background: #00d4ff; color: #fff; }
    .ps-academic { background: #ff8c42; color: #fff; }
    .ps-inactive { background: #e74c3c; color: #fff; }
    select.btn-toggle { max-width: 110px; font-size: 0.75rem; padding: 4px 6px; }

    /* Save flash */
    .save-flash {
        color: var(--lz-success, #4ade80);
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 12px;
        opacity: 1;
        transition: none;
    }
    .save-flash.flash-fade {
        transition: opacity 1.5s ease 1s;
        opacity: 0;
    }

    /* Insights picker */
    .insights-add-row {
        display: flex; gap: 8px; align-items: stretch; margin-bottom: 8px;
    }
    .form-group .insights-add-row select,
    .form-group .insights-add-row input,
    .form-group .insights-add-row .btn-secondary {
        padding: 10px 14px;
        font-size: 0.9rem;
        border-radius: 8px;
        border: 2px solid var(--noir-gray, rgba(255,255,255,0.1));
        box-sizing: border-box;
        width: auto;
    }
    .form-group .insights-add-row select {
        min-width: 130px;
        background: var(--noir-dark, #111); color: var(--noir-white, #eee);
        cursor: pointer;
    }
    .form-group .insights-add-row input {
        flex: 1; min-width: 0;
        background: var(--noir-dark, #111); color: var(--noir-white, #eee);
    }
    .insights-table {
        width: 100%; border-collapse: collapse;
    }
    .insights-table td {
        padding: 6px 8px; border-bottom: 1px solid var(--noir-gray, rgba(255,255,255,0.06));
        font-size: 0.85rem; color: var(--noir-silver, #aaa);
        vertical-align: middle;
    }
    .insight-dot {
        display: inline-block; width: 10px; height: 10px; border-radius: 50%;
    }
    .insight-remove {
        background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.25);
        color: #f87171; cursor: pointer; font-size: 0.75rem; padding: 2px 8px;
        border-radius: 4px; line-height: 1.4; font-weight: 600;
    }
    .insight-remove:hover { background: rgba(248, 113, 113, 0.25); color: #ff4444; }
    .insight-edit {
        background: rgba(212, 168, 85, 0.1); border: 1px solid rgba(212, 168, 85, 0.25);
        color: #d4a855; cursor: pointer; font-size: 0.75rem; padding: 2px 8px;
        border-radius: 4px; line-height: 1.4; font-weight: 600;
    }
    .insight-edit:hover { background: rgba(212, 168, 85, 0.25); color: #e8b960; }
    .insight-inline-edit {
        width: 100%; padding: 6px 8px; font-size: 0.85rem;
        background: transparent; color: var(--noir-white, #eee);
        border: 1px solid #d4a855; border-radius: 4px;
        box-sizing: border-box; outline: none;
        font-family: inherit;
    }

    /* Image Browser Modal */
    .ib-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    #imageBrowserModal { z-index: 1050; }
    .ib-card {
        background: var(--noir-charcoal, #1a1a2e); border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
        border-radius: 12px; width: 90%; max-width: 700px; max-height: 80vh;
        display: flex; flex-direction: column;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .ib-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .ib-header h3 { margin: 0; font-size: 1.1rem; }
    .ib-close {
        background: none; border: none; color: rgba(255,255,255,0.6);
        font-size: 1.5rem; cursor: pointer; padding: 4px 8px; border-radius: 4px;
    }
    .ib-close:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .ib-tabs {
        display: flex; gap: 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 0 20px;
    }
    .ib-tab {
        padding: 10px 18px; background: none; border: none; border-bottom: 2px solid transparent;
        color: rgba(255,255,255,0.5); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
    }
    .ib-tab.active { color: #4a90d9; border-bottom-color: #4a90d9; }
    .ib-tab:hover:not(.active) { color: rgba(255,255,255,0.8); }
    .ib-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
    .ib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .ib-item {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px; overflow: hidden; transition: all 0.2s;
    }
    .ib-item:hover { border-color: rgba(255,255,255,0.2); }
    .ib-item img { width: 100%; height: 100px; object-fit: cover; display: block; }
    .ib-filename {
        display: block; padding: 4px 8px; font-size: 0.7rem;
        color: rgba(255,255,255,0.5); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .ib-actions { display: flex; gap: 4px; padding: 4px 8px 8px; }
    .ib-select-btn {
        flex: 1; padding: 4px 8px; background: #4a90d9; color: #fff;
        border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;
    }
    .ib-select-btn:hover { background: #3a7bc8; }
    .ib-delete-btn {
        padding: 4px 8px; background: rgba(231,76,60,0.15); color: #e74c3c;
        border: 1px solid rgba(231,76,60,0.3); border-radius: 4px;
        font-size: 0.75rem; cursor: pointer;
    }
    .ib-delete-btn:hover { background: rgba(231,76,60,0.3); }
    /* Multi-select state */
    .ib-item.ib-selected {
        border-color: var(--accent-gold, #e8c547);
        box-shadow: 0 0 0 2px rgba(232,197,71,0.3);
    }
    .ib-item.ib-selected::after {
        content: '\2713';
        position: absolute;
        top: 6px;
        right: 6px;
        background: var(--accent-gold, #e8c547);
        color: #000;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
    }
    .ib-item { position: relative; cursor: pointer; }
    /* Footer bar for multi-select */
    .ib-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-top: 1px solid rgba(255,255,255,0.08);
        background: rgba(0,0,0,0.2);
    }
    .ib-footer span {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.6);
        font-family: var(--font-heading, sans-serif);
    }
    @media (max-width: 600px) {
        .ib-grid { grid-template-columns: repeat(2, 1fr); }
        .ib-card { width: 95%; max-height: 90vh; }
    }

    /* Tech autocomplete */
    .tech-input-wrap {
        position: relative;
        display: flex; flex-wrap: wrap; align-items: center; gap: 6px;
        background: var(--noir-charcoal, #1a1a2e);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
        border-radius: 8px; padding: 6px 10px; min-height: 42px; cursor: text;
        transition: border-color 0.2s;
    }
    .tech-input-wrap:focus-within { border-color: var(--lz-accent, #c4788a); }
    .tech-tags { display: contents; }
    .tech-pill {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;
        white-space: nowrap; line-height: 1.4;
    }
    .tech-pill-x {
        background: none; border: none; color: inherit; cursor: pointer;
        font-size: 1rem; line-height: 1; padding: 0 0 0 2px; opacity: 0.6;
    }
    .tech-pill-x:hover { opacity: 1; }
    #techSearchInput {
        flex: 1; min-width: 120px; background: transparent; border: none; outline: none;
        color: var(--noir-white, #e0e0e0); font-size: 0.9rem; padding: 4px 0;
    }
    #techSearchInput::placeholder { color: rgba(255,255,255,0.3); }
    .tech-dropdown {
        display: none; position: absolute; top: 100%; left: 0; right: 0;
        background: var(--noir-charcoal, #1a1a2e);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.15));
        border-radius: 8px; margin-top: 4px; max-height: 220px; overflow-y: auto;
        z-index: 50; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .tech-dropdown-item {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 12px; cursor: pointer; font-size: 0.85rem;
        color: var(--noir-white, #e0e0e0); transition: background 0.15s;
    }
    .tech-dropdown-item:hover, .tech-dropdown-item.active {
        background: rgba(255,255,255,0.08);
    }
    .tech-dd-dot {
        width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .tech-dd-cat {
        margin-left: auto; font-size: 0.7rem; opacity: 0.45; text-transform: capitalize;
    }
    .tech-category-picker {
        display: flex; align-items: center; gap: 8px; flex-basis: 100%;
        padding: 8px 0 2px; font-size: 0.82rem;
    }
    .tcp-label { color: rgba(255,255,255,0.6); white-space: nowrap; }
    #techCategorySelect {
        padding: 4px 8px; border-radius: 6px; font-size: 0.82rem;
        background: var(--noir-dark, #0f0f1a); color: var(--noir-white, #e0e0e0);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.15));
    }
    .tcp-add {
        padding: 4px 12px; border-radius: 6px; font-size: 0.82rem;
        background: var(--lz-accent, #c4788a); color: #fff; border: none; cursor: pointer;
    }
    .tcp-add:hover { opacity: 0.85; }
    .tcp-cancel {
        padding: 4px 10px; border-radius: 6px; font-size: 0.82rem;
        background: transparent; color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.15); cursor: pointer;
    }
    .tcp-cancel:hover { color: rgba(255,255,255,0.8); }

    /* Focal point drag positioner */
    .focal-dragger {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.12);
        background: var(--noir-dark, #0f0f1a);
        cursor: grab;
        user-select: none;
        -webkit-user-select: none;
    }
    .focal-dragger.dragging { cursor: grabbing; }
    .focal-dragger-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: rgba(255,255,255,0.3);
        font-size: 0.85rem;
    }
    #focalDraggerImg {
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
    }
    .focal-dragger-hint {
        position: absolute;
        bottom: 6px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.65);
        color: rgba(255,255,255,0.75);
        padding: 2px 10px;
        border-radius: 10px;
        font-size: 0.7rem;
        pointer-events: none;
        letter-spacing: 0.03em;
    }

    /* Gallery layout picker */
    .gallery-layout-picker { display: flex; gap: 6px; }
    .gl-btn {
        padding: 6px 16px; border-radius: 6px; font-size: 0.85rem;
        background: var(--noir-dark, #0f0f1a); color: rgba(255,255,255,0.5);
        border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.2s;
    }
    .gl-btn.active {
        background: var(--lz-accent, #c4788a); color: #fff;
        border-color: var(--lz-accent, #c4788a);
    }
    .gl-btn:hover:not(.active) { color: rgba(255,255,255,0.8); border-color: rgba(255,255,255,0.25); }

    /* Gallery thumbnails */
    .gallery-thumbs {
        display: flex; flex-wrap: wrap; gap: 8px; min-height: 60px;
        padding: 8px; border-radius: 8px;
        background: var(--noir-dark, #0f0f1a);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
    }
    .gallery-empty {
        width: 100%; text-align: center; color: rgba(255,255,255,0.3);
        font-size: 0.85rem; margin: 10px 0;
    }
    .gallery-thumb {
        position: relative; width: 80px; height: 80px; border-radius: 6px;
        overflow: hidden; border: 2px solid transparent;
        cursor: grab; transition: border-color 0.2s, opacity 0.2s;
    }
    .gallery-thumb:hover { border-color: var(--lz-accent, #c4788a); }
    .gallery-thumb.dragging { opacity: 0.4; }
    .gallery-thumb.drag-over { border-color: #4a90d9; }
    .gallery-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .gallery-thumb-num {
        position: absolute; top: 3px; left: 3px;
        background: rgba(0,0,0,0.7); color: #fff; font-size: 0.65rem;
        padding: 1px 5px; border-radius: 3px; line-height: 1.3;
    }
    .gallery-thumb-remove {
        position: absolute; top: 2px; right: 2px;
        background: rgba(231,76,60,0.85); color: #fff;
        border: none; border-radius: 50%; width: 18px; height: 18px;
        font-size: 0.75rem; line-height: 1; cursor: pointer;
        display: none; align-items: center; justify-content: center;
    }
    .gallery-thumb:hover .gallery-thumb-remove { display: flex; }
    .gallery-thumb-remove:hover { background: #e74c3c; }

    /* Inline image toolbar */
    .img-toolbar {
        position: fixed;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        background: var(--noir-charcoal, #1a1a2e);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.15));
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        white-space: nowrap;
    }
    .img-tb-group {
        display: flex;
        align-items: center;
        gap: 3px;
    }
    .img-tb-label {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.4);
        margin-right: 2px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .img-tb-sep {
        width: 1px;
        height: 20px;
        background: rgba(255,255,255,0.12);
        margin: 0 6px;
    }
    .img-tb-btn {
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.78rem;
        background: var(--noir-dark, #0f0f1a);
        color: rgba(255,255,255,0.5);
        border: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: all 0.15s;
    }
    .img-tb-btn.active {
        background: var(--lz-accent, #c4788a);
        color: #fff;
        border-color: var(--lz-accent, #c4788a);
    }
    .img-tb-btn:hover:not(.active) {
        color: rgba(255,255,255,0.8);
        border-color: rgba(255,255,255,0.25);
    }

    /* Selected image highlight in editor */
    .ql-editor img.img-selected {
        outline: 2px solid var(--lz-accent, #c4788a);
        outline-offset: 2px;
        border-radius: 4px;
    }

    /* Editor-side image sizing */
    .ql-editor img[data-size="small"] { max-width: 33%; }
    .ql-editor img[data-size="medium"] { max-width: 50%; }
    .ql-editor img[data-size="large"],
    .ql-editor img[data-size="full"] { max-width: 100%; }

    /* Selected filmstrip highlight */
    .ql-editor .img-filmstrip.img-selected {
        outline: 2px solid var(--lz-accent, #c4788a);
        outline-offset: 2px;
        border-radius: 4px;
    }

    /* Filmstrip Modal */
    .fs-body { padding: 16px 20px; display: flex; flex-direction: column; gap: 16px; }
    .fs-preview {
        display: flex; gap: 6px; overflow-x: auto; overflow-y: hidden;
        padding: 10px; min-height: 120px; align-items: center;
        background: var(--noir-dark, #0f0f1a);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
        border-radius: 8px;
        -webkit-overflow-scrolling: touch;
    }
    .fs-preview::-webkit-scrollbar { height: 5px; }
    .fs-preview::-webkit-scrollbar-track { background: transparent; }
    .fs-preview::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    .fs-empty { color: rgba(255,255,255,0.3); font-size: 0.85rem; text-align: center; width: 100%; }
    .fs-thumb {
        position: relative; flex: none; height: 100px;
        border-radius: 6px; overflow: hidden;
        border: 2px solid transparent; cursor: grab;
        transition: border-color 0.2s, opacity 0.2s;
    }
    .fs-thumb:hover { border-color: var(--lz-accent, #c4788a); }
    .fs-thumb.dragging { opacity: 0.4; }
    .fs-thumb.drag-over { border-color: #4a90d9; }
    .fs-thumb img { height: 100%; width: auto; display: block; }
    .fs-thumb-actions {
        position: absolute; top: 3px; right: 3px;
        display: none; gap: 3px;
    }
    .fs-thumb:hover .fs-thumb-actions { display: flex; }
    .fs-crop-btn, .fs-remove-btn {
        width: 22px; height: 22px; border-radius: 4px;
        border: none; cursor: pointer; font-size: 0.8rem;
        display: flex; align-items: center; justify-content: center;
        line-height: 1;
    }
    .fs-crop-btn {
        background: rgba(74,144,217,0.85); color: #fff;
    }
    .fs-crop-btn:hover { background: #4a90d9; }
    .fs-remove-btn {
        background: rgba(231,76,60,0.85); color: #fff;
    }
    .fs-remove-btn:hover { background: #e74c3c; }
    .fs-crop-badge {
        position: absolute; bottom: 3px; left: 3px;
        background: rgba(46,204,64,0.85); color: #fff;
        font-size: 0.6rem; padding: 1px 6px; border-radius: 3px;
        pointer-events: none;
    }
    .fs-add-section { display: flex; flex-direction: column; gap: 6px; }
    .fs-add-section input[type="text"] {
        background: var(--noir-dark, #111); border: 2px solid var(--noir-gray, #333);
        color: var(--noir-white, #e0e0e0); padding: 10px 14px; border-radius: 8px;
        font-family: inherit; font-size: 0.9rem; transition: border-color 0.2s;
        box-sizing: border-box;
    }
    .fs-add-section input[type="text"]:focus {
        outline: none; border-color: var(--lz-accent, #c4788a);
        box-shadow: 0 0 0 3px rgba(196,120,138,0.12);
    }
    .fs-add-section input[type="text"]::placeholder { color: rgba(255,255,255,0.35); }
    .fs-add-section input[type="file"] {
        padding: 10px; background: var(--noir-dark, #111);
        border: 2px dashed var(--noir-gray, #333); border-radius: 8px;
        color: var(--noir-white, #e0e0e0); font-size: 0.85rem;
        cursor: pointer; transition: border-color 0.2s;
        box-sizing: border-box;
    }
    .fs-add-section input[type="file"]:hover {
        border-color: var(--lz-accent, #c4788a);
    }
    .fs-add-section input[type="file"]::-webkit-file-upload-button {
        background: var(--noir-white, #e0e0e0); color: var(--noir-black, #111);
        border: none; padding: 6px 14px; border-radius: 6px;
        font-weight: 500; cursor: pointer; margin-right: 10px;
    }
    .fs-add-section input[type="file"]::-webkit-file-upload-button:hover {
        background: var(--noir-silver, #ccc);
    }
    .fs-actions { display: flex; gap: 8px; justify-content: flex-end; padding-top: 8px; }

    /* Crop Modal */
    .crop-card { max-width: 800px; }
    .crop-body { padding: 16px 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .crop-canvas-wrap {
        background: #000; border-radius: 6px; overflow: hidden;
        display: flex; align-items: center; justify-content: center;
    }
    .crop-info {
        font-size: 0.8rem; color: rgba(255,255,255,0.5);
        font-family: monospace; letter-spacing: 0.05em;
    }
    .crop-actions { display: flex; gap: 8px; }

    /* Quill filmstrip toolbar button */
    .ql-filmstrip { position: relative; }

    /* Editor-side filmstrip blot */
    .ql-editor .img-filmstrip {
        display: flex;
        gap: 3px;
        margin: 16px 0;
        border-radius: 8px;
        overflow-x: auto;
        overflow-y: hidden;
        border: 1px solid rgba(255,255,255,0.1);
        background: rgba(0,0,0,0.2);
        position: relative;
    }
    .ql-editor .img-filmstrip img {
        flex: none;
        width: auto;
        height: 200px;
        object-fit: cover;
        display: block;
        margin: 0;
        border-radius: 0;
    }
    /* Filmstrip sizes in editor */
    .ql-editor .img-filmstrip[data-size="small"] img { height: 120px; }
    .ql-editor .img-filmstrip[data-size="medium"] img { height: 200px; }
    .ql-editor .img-filmstrip[data-size="large"] img { height: 320px; }
    .ql-editor .img-filmstrip::-webkit-scrollbar { height: 4px; }
    .ql-editor .img-filmstrip::-webkit-scrollbar-track { background: transparent; }
    .ql-editor .img-filmstrip::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }

    </style>
</body>
</html>
