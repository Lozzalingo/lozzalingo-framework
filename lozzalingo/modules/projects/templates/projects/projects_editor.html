<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects Editor - Admin</title>
    <script src="{{ url_for('admin.static', filename='js/admin-theme.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css">
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/newseditor.css') }}">
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/admin-theme.css') }}">
</head>
<body>
    {% include 'header.html' ignore missing %}

    <div class="editor-container">
        <header class="editor-header">
            <h1>Projects Editor</h1>
            <div class="header-actions">
                <button class="lz-theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"><span class="theme-icon"></span></button>
                <a href="{{ url_for('admin.dashboard') }}" class="back-link">Back to Dashboard</a>
            </div>
        </header>

        <div class="editor-content">
            <div class="editor-form">
                <h2 id="formTitle">Create New Project</h2>

                <form id="projectForm" enctype="multipart/form-data">
                    <input type="hidden" id="projectId">

                    <div class="form-group">
                        <label for="title">Project Title *</label>
                        <input type="text" id="title" name="title" required placeholder="Enter project title...">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="year">Year (Start)</label>
                            <input type="number" id="year" name="year" placeholder="e.g. 2024" min="1990" max="2099">
                        </div>
                        <div class="form-group">
                            <label for="yearEnd">Year End</label>
                            <input type="number" id="yearEnd" name="year_end" placeholder="Leave blank for ongoing" min="1990" max="2099">
                            <small class="form-hint">Leave blank for ongoing projects</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="projectStatus">Activity</label>
                            <select id="projectStatus" name="project_status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                            <small class="form-hint">Shown as a label on the public page</small>
                        </div>
                        <div class="form-group">
                            <label for="grossEarnings">Gross Earnings (est.)</label>
                            <div style="display: flex; gap: 8px;">
                                <select id="earningsCurrency" name="earnings_currency" style="width: 70px; flex-shrink: 0;">
                                    <option value="£">£</option>
                                    <option value="$">$</option>
                                    <option value="€">€</option>
                                </select>
                                <input type="number" id="grossEarnings" name="gross_earnings" placeholder="e.g. 50000" min="0" step="0.01" style="flex: 1;">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="techSearchInput">Technologies</label>
                        <div class="tech-input-wrap" id="techInputWrap">
                            <div class="tech-tags" id="techTags"></div>
                            <input type="text" id="techSearchInput" autocomplete="off" placeholder="Type to search technologies...">
                            <div class="tech-dropdown" id="techDropdown"></div>
                            <div class="tech-category-picker" id="techCategoryPicker" style="display:none;">
                                <span class="tcp-label">New tech — pick category:</span>
                                <select id="techCategorySelect">
                                    <option value="software">Software</option>
                                    <option value="hardware">Hardware</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="clients">Clients</option>
                                    <option value="equipment">Equipment</option>
                                    <option value="logistics">Logistics</option>
                                    <option value="materials">Materials</option>
                                    <option value="services">Services</option>
                                    <option value="other">Other</option>
                                </select>
                                <button type="button" class="tcp-add" id="techCategoryAddBtn">Add</button>
                                <button type="button" class="tcp-cancel" id="techCategoryCancelBtn">Cancel</button>
                            </div>
                        </div>
                        <input type="hidden" id="technologies" name="technologies">
                        <small class="form-hint">Type to search & add — <a href="{{ url_for('projects_admin.tech_registry') }}" style="color: var(--lz-accent, #c4788a);">Manage Tech Registry</a></small>
                    </div>

                    <div class="form-group">
                        <label>Gallery Layout</label>
                        <div class="gallery-layout-picker" id="galleryLayoutPicker">
                            <button type="button" class="gl-btn active" data-layout="single">Single</button>
                            <button type="button" class="gl-btn" data-layout="carousel">Carousel</button>
                            <button type="button" class="gl-btn" data-layout="grid">Grid</button>
                        </div>
                        <input type="hidden" id="galleryLayout" name="gallery_layout" value="single">
                    </div>

                    <div class="form-group">
                        <label>Hero Image Focal Point</label>
                        <div class="focal-grid" id="focalGrid">
                            <button type="button" class="focal-cell" data-align="left top" title="Top Left"></button>
                            <button type="button" class="focal-cell" data-align="center top" title="Top Center"></button>
                            <button type="button" class="focal-cell" data-align="right top" title="Top Right"></button>
                            <button type="button" class="focal-cell" data-align="left center" title="Center Left"></button>
                            <button type="button" class="focal-cell active" data-align="center center" title="Center"></button>
                            <button type="button" class="focal-cell" data-align="right center" title="Center Right"></button>
                            <button type="button" class="focal-cell" data-align="left bottom" title="Bottom Left"></button>
                            <button type="button" class="focal-cell" data-align="center bottom" title="Bottom Center"></button>
                            <button type="button" class="focal-cell" data-align="right bottom" title="Bottom Right"></button>
                        </div>
                        <input type="hidden" id="heroImageAlign" name="hero_image_align" value="center center">
                        <small class="form-hint">Controls where the hero image anchors when cropped</small>
                    </div>

                    <div class="form-group">
                        <label>Gallery Images</label>
                        <div class="gallery-thumbs" id="galleryThumbs"></div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                            <input type="file" id="imageFile" name="image" accept="image/*,.heic,.heif" style="flex:1;">
                            <button type="button" class="btn-secondary" id="browseImagesBtn" style="white-space:nowrap;">Browse</button>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                            <input type="text" id="galleryUrlInput" placeholder="Paste image URL..." style="flex:1;">
                            <button type="button" class="btn-secondary" id="galleryAddUrlBtn" style="white-space:nowrap;">Add URL</button>
                        </div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                            <span class="progress-text" id="progressText">Uploading...</span>
                        </div>
                        <input type="hidden" id="galleryImagesHidden" name="gallery_images">
                        <input type="hidden" id="imageUrl" name="image_url">
                    </div>

                    <div class="form-group">
                        <label for="content">Project Description *</label>
                        <div id="editor"></div>
                        <input type="hidden" id="content" name="content">
                    </div>

                    <div class="form-section">
                        <h3 class="form-section-title">SEO & Metadata</h3>
                        <div class="form-group">
                            <label for="excerpt">Excerpt</label>
                            <textarea id="excerpt" name="excerpt" rows="2" placeholder="Short description for previews (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="metaDescription">Meta Description</label>
                            <textarea id="metaDescription" name="meta_description" rows="2" placeholder="SEO description (optional)"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-primary" id="publishBtn">Publish Project</button>
                        <button type="button" class="btn-secondary" id="draftBtn">Save as Draft</button>
                        <button type="button" class="btn-secondary" id="cancelBtn" style="display: none;">Cancel Edit</button>
                    </div>
                    <div id="statusIndicator" class="status-indicator" style="display: none;">
                        Visibility: <span id="currentStatus"></span> &nbsp;|&nbsp; Activity: <span id="currentProjectStatus"></span>
                    </div>
                </form>
            </div>

            <div class="articles-list">
                <div class="list-header">
                    <h2>Manage Projects</h2>
                    <div class="filter-controls">
                        <input type="text" id="projectSearch" class="filter-input" placeholder="Search projects...">
                        <select id="projectFilter" class="filter-select">
                            <option value="all">All</option>
                            <option value="published">Published</option>
                            <option value="draft">Drafts</option>
                        </select>
                        <span id="projectCount" class="item-count"></span>
                    </div>
                </div>
                <div id="projectsList"></div>
            </div>
        </div>
    </div>

    <!-- Image Browser Modal -->
    <div id="imageBrowserModal" class="ib-overlay" style="display:none;">
        <div class="ib-card">
            <div class="ib-header">
                <h3>Browse Images</h3>
                <button type="button" class="ib-close" id="ibCloseBtn">&times;</button>
            </div>
            <div class="ib-tabs">
                <button type="button" class="ib-tab" data-folder="quick-links">Quick Links</button>
                <button type="button" class="ib-tab" data-folder="blog">Blog</button>
                <button type="button" class="ib-tab active" data-folder="projects">Projects</button>
            </div>
            <div class="ib-body">
                <div id="ibGrid" class="ib-grid"></div>
            </div>
        </div>
    </div>

    <!-- Floating image toolbar (positioned inside .ql-container) -->
    <div id="imgToolbar" class="img-toolbar" style="display:none;">
        <span class="img-tb-group">
            <span class="img-tb-label">Size</span>
            <button type="button" class="img-tb-btn" data-size="small">S</button>
            <button type="button" class="img-tb-btn" data-size="medium">M</button>
            <button type="button" class="img-tb-btn" data-size="full">Full</button>
        </span>
        <span class="img-tb-sep"></span>
        <span class="img-tb-group">
            <span class="img-tb-label">Group</span>
            <button type="button" class="img-tb-btn" data-layout="single">Single</button>
            <button type="button" class="img-tb-btn" data-layout="carousel">Carousel</button>
            <button type="button" class="img-tb-btn" data-layout="grid">Grid</button>
        </span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script>
    // Custom Image blot — preserves data-size, data-layout, width on <img>
    (function() {
        const BaseImage = Quill.import('formats/image');

        class CustomImage extends BaseImage {
            static create(value) {
                const node = super.create(value);
                if (typeof value === 'object' && value !== null) {
                    if (value['data-size']) node.setAttribute('data-size', value['data-size']);
                    if (value['data-layout']) node.setAttribute('data-layout', value['data-layout']);
                    if (value.width) node.style.width = value.width;
                }
                return node;
            }

            static value(node) {
                return {
                    src: node.getAttribute('src'),
                    alt: node.getAttribute('alt') || '',
                    'data-size': node.getAttribute('data-size') || '',
                    'data-layout': node.getAttribute('data-layout') || '',
                    width: node.style.width || ''
                };
            }

            static formats(node) {
                const fmt = {};
                if (node.getAttribute('data-size')) fmt['data-size'] = node.getAttribute('data-size');
                if (node.getAttribute('data-layout')) fmt['data-layout'] = node.getAttribute('data-layout');
                if (node.style.width) fmt.width = node.style.width;
                const alt = node.getAttribute('alt');
                if (alt) fmt.alt = alt;
                return fmt;
            }

            format(name, value) {
                if (name === 'data-size') {
                    if (value) this.domNode.setAttribute('data-size', value);
                    else this.domNode.removeAttribute('data-size');
                    // Also set width
                    const widths = { small: '33%', medium: '50%', full: '100%' };
                    this.domNode.style.width = widths[value] || '';
                } else if (name === 'data-layout') {
                    if (value) this.domNode.setAttribute('data-layout', value);
                    else this.domNode.removeAttribute('data-layout');
                } else if (name === 'width') {
                    if (value) this.domNode.style.width = value;
                    else this.domNode.style.width = '';
                } else {
                    super.format(name, value);
                }
            }
        }

        CustomImage.blotName = 'image';
        CustomImage.tagName = 'IMG';

        Quill.register(CustomImage, true);
    })();
    </script>
    <script src="{{ url_for('admin.static', filename='js/image-compress.js') }}"></script>
    <script>
    (function() {
        const API_BASE = '/admin/projects-editor/api/projects';
        const UPLOAD_URL = '/admin/projects-editor/upload-image';
        const LIST_URL = '/admin/projects-editor/list-images';
        const DELETE_URL = '/admin/projects-editor/delete-image';
        const TECH_REGISTRY_URL = '/admin/projects-editor/api/tech-registry';

        /* ── Tech autocomplete ── */
        const TECH_COLORS = {
            software: '#d4a855', hardware: '#4a9eff', marketing: '#ffa032',
            clients: '#e65064', equipment: '#b4b4c3', logistics: '#2ecc40',
            materials: '#64c8f0', services: '#1ad6ba', other: '#b164ff'
        };
        let techRegistry = [];          // [{name, category}, ...]
        let selectedTechs = [];         // [{name, category}, ...]
        let techDropdownIdx = -1;       // keyboard nav index

        async function loadTechRegistry() {
            try {
                const res = await fetch(TECH_REGISTRY_URL);
                techRegistry = await res.json();
            } catch (e) { console.error('Tech registry load failed', e); }
        }
        loadTechRegistry();

        const techSearchInput = document.getElementById('techSearchInput');
        const techDropdown = document.getElementById('techDropdown');
        const techTagsEl = document.getElementById('techTags');
        const techHidden = document.getElementById('technologies');
        const techWrap = document.getElementById('techInputWrap');
        const techCategoryPicker = document.getElementById('techCategoryPicker');
        const techCategorySelect = document.getElementById('techCategorySelect');
        let pendingTechName = '';

        function syncTechHidden() {
            techHidden.value = selectedTechs.map(t => t.name).join(', ');
        }

        function renderTechTags() {
            techTagsEl.innerHTML = selectedTechs.map((t, i) => {
                const c = TECH_COLORS[t.category] || TECH_COLORS.other;
                return `<span class="tech-pill" style="background:rgba(${hexToRgb(c)},0.15);color:${c};border:1px solid rgba(${hexToRgb(c)},0.3);">${escHtml(t.name)}<button type="button" class="tech-pill-x" data-idx="${i}">&times;</button></span>`;
            }).join('');
            techTagsEl.querySelectorAll('.tech-pill-x').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectedTechs.splice(+this.dataset.idx, 1);
                    renderTechTags();
                    syncTechHidden();
                });
            });
        }

        function hexToRgb(hex) {
            const h = hex.replace('#', '');
            return [parseInt(h.substring(0,2),16), parseInt(h.substring(2,4),16), parseInt(h.substring(4,6),16)].join(',');
        }

        function escHtml(s) {
            const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
        }

        function addTech(name, category) {
            const n = name.trim().toLowerCase();
            if (!n || selectedTechs.some(t => t.name === n)) return;
            selectedTechs.push({ name: n, category: category || 'other' });
            renderTechTags();
            syncTechHidden();
            techSearchInput.value = '';
            hideTechDropdown();
        }

        function showTechDropdown(items) {
            if (!items.length) { hideTechDropdown(); return; }
            techDropdownIdx = -1;
            techDropdown.innerHTML = items.map((t, i) => {
                const c = TECH_COLORS[t.category] || TECH_COLORS.other;
                return `<div class="tech-dropdown-item" data-idx="${i}"><span class="tech-dd-dot" style="background:${c};"></span>${escHtml(t.name)}<span class="tech-dd-cat">${t.category}</span></div>`;
            }).join('');
            techDropdown.style.display = 'block';
            techDropdown._items = items;
            techDropdown.querySelectorAll('.tech-dropdown-item').forEach(el => {
                el.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const idx = +this.dataset.idx;
                    addTech(techDropdown._items[idx].name, techDropdown._items[idx].category);
                });
            });
        }

        function hideTechDropdown() {
            techDropdown.style.display = 'none';
            techDropdown.innerHTML = '';
            techDropdownIdx = -1;
        }

        techSearchInput.addEventListener('input', function() {
            techCategoryPicker.style.display = 'none';
            const q = this.value.trim().toLowerCase();
            if (!q) { hideTechDropdown(); return; }
            const selectedNames = new Set(selectedTechs.map(t => t.name));
            const matches = techRegistry.filter(t => t.name.includes(q) && !selectedNames.has(t.name));
            showTechDropdown(matches.slice(0, 12));
        });

        techSearchInput.addEventListener('keydown', function(e) {
            const items = techDropdown._items || [];
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (items.length) {
                    techDropdownIdx = Math.min(techDropdownIdx + 1, items.length - 1);
                    highlightDropdownItem();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (items.length) {
                    techDropdownIdx = Math.max(techDropdownIdx - 1, 0);
                    highlightDropdownItem();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (techDropdownIdx >= 0 && items[techDropdownIdx]) {
                    addTech(items[techDropdownIdx].name, items[techDropdownIdx].category);
                } else {
                    const q = this.value.trim().toLowerCase();
                    if (!q) return;
                    const existing = techRegistry.find(t => t.name === q);
                    if (existing) {
                        addTech(existing.name, existing.category);
                    } else {
                        pendingTechName = q;
                        techCategoryPicker.style.display = 'flex';
                        techCategorySelect.focus();
                        hideTechDropdown();
                    }
                }
            } else if (e.key === 'Escape') {
                hideTechDropdown();
                techCategoryPicker.style.display = 'none';
            } else if (e.key === 'Backspace' && !this.value && selectedTechs.length) {
                selectedTechs.pop();
                renderTechTags();
                syncTechHidden();
            }
        });

        function highlightDropdownItem() {
            techDropdown.querySelectorAll('.tech-dropdown-item').forEach((el, i) => {
                el.classList.toggle('active', i === techDropdownIdx);
            });
        }

        techSearchInput.addEventListener('blur', function() {
            setTimeout(function() {
                if (!techWrap.contains(document.activeElement)) hideTechDropdown();
            }, 150);
        });

        techWrap.addEventListener('click', function(e) {
            if (!e.target.closest('.tech-category-picker') && !e.target.closest('.tech-pill-x')) {
                techSearchInput.focus();
            }
        });

        // Category picker — add new tech to registry
        document.getElementById('techCategoryAddBtn').addEventListener('click', async function() {
            if (!pendingTechName) return;
            const cat = techCategorySelect.value;
            try {
                await fetch(TECH_REGISTRY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: pendingTechName, category: cat })
                });
                techRegistry.push({ name: pendingTechName, category: cat });
                addTech(pendingTechName, cat);
            } catch (e) { alert('Failed to register tech: ' + e.message); }
            techCategoryPicker.style.display = 'none';
            pendingTechName = '';
        });

        document.getElementById('techCategoryCancelBtn').addEventListener('click', function() {
            techCategoryPicker.style.display = 'none';
            pendingTechName = '';
            techSearchInput.focus();
        });

        function setTechsFromString(str) {
            selectedTechs = [];
            if (!str) { renderTechTags(); syncTechHidden(); return; }
            str.split(',').forEach(s => {
                const n = s.trim().toLowerCase();
                if (!n) return;
                const reg = techRegistry.find(t => t.name === n);
                selectedTechs.push({ name: n, category: reg ? reg.category : 'other' });
            });
            renderTechTags();
            syncTechHidden();
        }

        function clearTechs() {
            selectedTechs = [];
            techTagsEl.innerHTML = '';
            techHidden.value = '';
            techSearchInput.value = '';
            hideTechDropdown();
            techCategoryPicker.style.display = 'none';
        }

        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Write project description...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote', 'code-block'],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        let editingId = null;

        loadProjects();

        // === Inline Image Toolbar ===
        (function() {
            const toolbar = document.getElementById('imgToolbar');
            const qlEditor = document.querySelector('.ql-editor');
            let activeImg = null;

            function positionToolbar(img) {
                const imgRect = img.getBoundingClientRect();
                const tbHeight = toolbar.offsetHeight;
                let top = imgRect.top - tbHeight - 8;

                // If no room above viewport, place below the image
                if (top < 8) {
                    top = imgRect.bottom + 8;
                }

                toolbar.style.top = top + 'px';
                toolbar.style.left = Math.max(8, imgRect.left) + 'px';
            }

            function showToolbar(img) {
                activeImg = img;
                img.classList.add('img-selected');
                toolbar.style.display = 'flex';

                // Highlight active states
                const curSize = img.getAttribute('data-size') || 'full';
                const curLayout = img.getAttribute('data-layout') || 'single';
                toolbar.querySelectorAll('.img-tb-btn').forEach(btn => {
                    btn.classList.toggle('active',
                        (btn.dataset.size && btn.dataset.size === curSize) ||
                        (btn.dataset.layout && btn.dataset.layout === curLayout)
                    );
                });

                positionToolbar(img);
            }

            function hideToolbar() {
                toolbar.style.display = 'none';
                if (activeImg) activeImg.classList.remove('img-selected');
                activeImg = null;
            }

            // Use mousedown on document — Quill can swallow click events on images
            document.addEventListener('mousedown', function(e) {
                const img = e.target.closest ? e.target.closest('.ql-editor img') : null;
                if (img) {
                    // Delay slightly so Quill processes its own selection first
                    setTimeout(function() {
                        if (activeImg && activeImg !== img) activeImg.classList.remove('img-selected');
                        showToolbar(img);
                    }, 0);
                    return;
                }
                // Clicking on the toolbar itself — don't hide
                if (toolbar.contains(e.target)) return;
                // Clicking anywhere else — hide
                if (activeImg) hideToolbar();
            });

            // Reposition on scroll (editor can scroll)
            qlEditor.addEventListener('scroll', function() {
                if (activeImg) positionToolbar(activeImg);
            });
            window.addEventListener('scroll', function() {
                if (activeImg) positionToolbar(activeImg);
            }, { passive: true });

            // Escape hides toolbar
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') hideToolbar();
            });

            // Size buttons
            toolbar.querySelectorAll('.img-tb-btn[data-size]').forEach(btn => {
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!activeImg) return;
                    const size = this.dataset.size;
                    const blot = Quill.find(activeImg);
                    if (blot) {
                        blot.format('data-size', size);
                    }
                    showToolbar(activeImg); // refresh highlights
                });
            });

            // Layout buttons
            toolbar.querySelectorAll('.img-tb-btn[data-layout]').forEach(btn => {
                btn.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!activeImg) return;
                    const layout = this.dataset.layout;
                    const blot = Quill.find(activeImg);
                    if (blot) {
                        blot.format('data-layout', layout);
                    }
                    showToolbar(activeImg); // refresh highlights
                });
            });
        })();

        // === Gallery State ===
        let galleryImages = [];
        let galleryLayout = 'single';

        function syncGalleryHidden() {
            document.getElementById('galleryImagesHidden').value = galleryImages.length ? JSON.stringify(galleryImages) : '';
            document.getElementById('imageUrl').value = galleryImages[0] || '';
        }

        function addGalleryImage(url) {
            if (!url || galleryImages.includes(url)) return;
            galleryImages.push(url);
            renderGalleryThumbs();
            syncGalleryHidden();
        }

        function renderGalleryThumbs() {
            const container = document.getElementById('galleryThumbs');
            if (!galleryImages.length) { container.innerHTML = '<p class="gallery-empty">No images added yet</p>'; return; }
            container.innerHTML = galleryImages.map((url, i) => `
                <div class="gallery-thumb" draggable="true" data-idx="${i}">
                    <span class="gallery-thumb-num">${i + 1}</span>
                    <img src="${url}" alt="Gallery image ${i + 1}">
                    <button type="button" class="gallery-thumb-remove" data-idx="${i}">&times;</button>
                </div>
            `).join('');

            // Remove buttons
            container.querySelectorAll('.gallery-thumb-remove').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    galleryImages.splice(+this.dataset.idx, 1);
                    renderGalleryThumbs();
                    syncGalleryHidden();
                });
            });

            // Drag-and-drop reorder
            let dragIdx = null;
            container.querySelectorAll('.gallery-thumb').forEach(thumb => {
                thumb.addEventListener('dragstart', function(e) {
                    dragIdx = +this.dataset.idx;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                thumb.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    dragIdx = null;
                });
                thumb.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    this.classList.add('drag-over');
                });
                thumb.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                thumb.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const dropIdx = +this.dataset.idx;
                    if (dragIdx === null || dragIdx === dropIdx) return;
                    const [moved] = galleryImages.splice(dragIdx, 1);
                    galleryImages.splice(dropIdx, 0, moved);
                    renderGalleryThumbs();
                    syncGalleryHidden();
                });
            });
        }

        // Focal point grid picker
        let heroImageAlign = 'center center';
        document.querySelectorAll('#focalGrid .focal-cell').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#focalGrid .focal-cell').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                heroImageAlign = this.dataset.align;
                document.getElementById('heroImageAlign').value = heroImageAlign;
            });
        });

        // Gallery layout picker
        document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                galleryLayout = this.dataset.layout;
                document.getElementById('galleryLayout').value = galleryLayout;
            });
        });

        // Add URL button
        document.getElementById('galleryAddUrlBtn').addEventListener('click', function() {
            const input = document.getElementById('galleryUrlInput');
            const url = input.value.trim();
            if (url) { addGalleryImage(url); input.value = ''; }
        });
        document.getElementById('galleryUrlInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('galleryAddUrlBtn').click(); }
        });

        // === Image Browser Modal ===
        const ibModal = document.getElementById('imageBrowserModal');
        const ibGrid = document.getElementById('ibGrid');
        let ibCurrentFolder = 'projects';

        document.getElementById('browseImagesBtn').addEventListener('click', () => {
            ibModal.style.display = 'flex';
            loadBrowserImages(ibCurrentFolder);
        });

        document.getElementById('ibCloseBtn').addEventListener('click', () => {
            ibModal.style.display = 'none';
        });

        ibModal.addEventListener('click', (e) => {
            if (e.target === ibModal) ibModal.style.display = 'none';
        });

        document.querySelectorAll('.ib-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.ib-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                ibCurrentFolder = this.dataset.folder;
                loadBrowserImages(ibCurrentFolder);
            });
        });

        async function loadBrowserImages(folder) {
            ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.6;">Loading...</p>';
            try {
                const res = await fetch(`${LIST_URL}?folder=${folder}`);
                const images = await res.json();
                if (images.length === 0) {
                    ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.6;">No images in this folder.</p>';
                    return;
                }
                ibGrid.innerHTML = images.map(img => `
                    <div class="ib-item" data-url="${img.url}">
                        <img src="${img.url}" alt="${img.filename}" loading="lazy">
                        <span class="ib-filename">${img.filename}</span>
                        <div class="ib-actions">
                            <button type="button" class="ib-select-btn" data-url="${img.url}">Select</button>
                            <button type="button" class="ib-delete-btn" data-url="${img.url}" title="Delete">&#128465;</button>
                        </div>
                    </div>
                `).join('');

                ibGrid.querySelectorAll('.ib-select-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        addGalleryImage(this.dataset.url);
                        ibModal.style.display = 'none';
                    });
                });

                ibGrid.querySelectorAll('.ib-delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        handleDeleteImage(this.dataset.url);
                    });
                });
            } catch (e) {
                ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#e74c3c;">Failed to load images.</p>';
            }
        }

        async function handleDeleteImage(url) {
            try {
                const res = await fetch(DELETE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();

                if (data.in_use) {
                    const refs = data.references.map(r => `- ${r.type}: ${r.title}`).join('\n');
                    if (!confirm(`This image is in use:\n${refs}\n\nDelete anyway?`)) return;
                    const res2 = await fetch(DELETE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, force: true })
                    });
                    const data2 = await res2.json();
                    if (!data2.success) { alert('Delete failed: ' + (data2.error || 'Unknown error')); return; }
                } else if (!data.success) {
                    alert('Delete failed: ' + (data.error || 'Unknown error'));
                    return;
                }

                const item = ibGrid.querySelector(`.ib-item[data-url="${CSS.escape(url)}"]`);
                if (item) item.remove();
                if (!ibGrid.querySelector('.ib-item')) {
                    ibGrid.innerHTML = '<p style="grid-column:1/-1; text-align:center; opacity:0.6;">No images in this folder.</p>';
                }
            } catch (e) {
                alert('Delete error: ' + e.message);
            }
        }

        // Image upload → adds to gallery
        document.getElementById('imageFile')?.addEventListener('change', async function() {
            if (!this.files[0]) return;
            const compressed = typeof compressImageFile === 'function' ? await compressImageFile(this.files[0]) : this.files[0];
            const formData = new FormData();
            formData.append('image', compressed);
            const progress = document.getElementById('uploadProgress');
            progress.style.display = 'block';
            try {
                const res = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    addGalleryImage(data.image_url);
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) { alert('Upload error: ' + e.message); }
            finally { progress.style.display = 'none'; this.value = ''; }
        });

        // Save buttons
        document.getElementById('publishBtn').addEventListener('click', () => saveProject('published'));
        document.getElementById('draftBtn').addEventListener('click', () => saveProject('draft'));
        document.getElementById('cancelBtn').addEventListener('click', resetForm);

        async function loadProjects() {
            try {
                const res = await fetch(API_BASE);
                const projects = await res.json();
                renderProjects(projects);
            } catch (e) { console.error('Error loading projects:', e); }
        }

        function renderProjects(projects) {
            const container = document.getElementById('projectsList');
            const search = document.getElementById('projectSearch').value.toLowerCase();
            const filter = document.getElementById('projectFilter').value;

            let filtered = projects.filter(p => {
                if (filter !== 'all' && p.status !== filter) return false;
                if (search && !p.title.toLowerCase().includes(search)) return false;
                return true;
            });

            document.getElementById('projectCount').textContent = `${filtered.length} project${filtered.length !== 1 ? 's' : ''}`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No projects found</p></div>';
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="article-card" data-id="${p.id}">
                    <div class="article-card-header">
                        <h3 class="article-title">${p.title}</h3>
                        <div>
                            <span class="status-badge status-${p.status}">${p.status}</span>
                            <span class="status-badge ps-${p.project_status}">${p.project_status}</span>
                        </div>
                    </div>
                    <div class="article-meta">
                        ${p.year ? `<span>Year: ${p.year}</span>` : ''}
                        ${p.technologies ? `<span>Tech: ${p.technologies}</span>` : ''}
                        <span>Updated: ${new Date(p.updated_at).toLocaleDateString()}</span>
                    </div>
                    <div class="article-actions">
                        <button class="btn-small btn-edit" onclick="window._editProject(${p.id})">Edit</button>
                        <button class="btn-small btn-toggle" onclick="window._togglePublish(${p.id})">
                            ${p.status === 'published' ? 'Unpublish' : 'Publish'}
                        </button>
                        <button class="btn-small btn-toggle" onclick="window._toggleActivity(${p.id})">
                            ${p.project_status === 'active' ? 'Set Inactive' : 'Set Active'}
                        </button>
                        <button class="btn-small btn-delete" onclick="window._deleteProject(${p.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('projectSearch').addEventListener('input', () => fetch(API_BASE).then(r => r.json()).then(renderProjects));
        document.getElementById('projectFilter').addEventListener('change', () => fetch(API_BASE).then(r => r.json()).then(renderProjects));

        async function saveProject(status) {
            const title = document.getElementById('title').value.trim();
            const content = quill.root.innerHTML;
            if (!title || !content || content === '<p><br></p>') { alert('Title and content are required'); return; }

            syncGalleryHidden();
            const body = {
                title, content,
                image_url: document.getElementById('imageUrl').value.trim(),
                year: document.getElementById('year').value || null,
                year_end: document.getElementById('yearEnd').value || null,
                status: status,
                project_status: document.getElementById('projectStatus').value,
                technologies: document.getElementById('technologies').value.trim() || null,
                excerpt: document.getElementById('excerpt').value.trim() || null,
                meta_description: document.getElementById('metaDescription').value.trim() || null,
                gross_earnings: document.getElementById('grossEarnings').value || null,
                earnings_currency: document.getElementById('earningsCurrency').value || null,
                gallery_images: document.getElementById('galleryImagesHidden').value || null,
                gallery_layout: document.getElementById('galleryLayout').value || 'single',
                hero_image_align: document.getElementById('heroImageAlign').value || 'center center'
            };

            try {
                const url = editingId ? `${API_BASE}/${editingId}` : API_BASE;
                const method = editingId ? 'PUT' : 'POST';
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await res.json();
                if (data.success || data.id) { resetForm(); loadProjects(); }
                else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error saving project: ' + e.message); }
        }

        window._editProject = async function(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}`);
                const p = await res.json();
                editingId = id;
                document.getElementById('projectId').value = id;
                document.getElementById('title').value = p.title || '';
                document.getElementById('year').value = p.year || '';
                document.getElementById('yearEnd').value = p.year_end || '';
                document.getElementById('projectStatus').value = p.project_status || 'active';
                setTechsFromString(p.technologies || '');
                // Load gallery state (backward compat: legacy image_url → 1-item gallery)
                if (p.gallery_images) {
                    try { galleryImages = JSON.parse(p.gallery_images); } catch (e) { galleryImages = []; }
                } else if (p.image_url) {
                    galleryImages = [p.image_url];
                } else {
                    galleryImages = [];
                }
                galleryLayout = p.gallery_layout || 'single';
                document.getElementById('galleryLayout').value = galleryLayout;
                document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.layout === galleryLayout);
                });
                renderGalleryThumbs();
                syncGalleryHidden();

                // Restore focal point
                heroImageAlign = p.hero_image_align || 'center center';
                document.getElementById('heroImageAlign').value = heroImageAlign;
                document.querySelectorAll('#focalGrid .focal-cell').forEach(b => {
                    b.classList.toggle('active', b.dataset.align === heroImageAlign);
                });

                document.getElementById('excerpt').value = p.excerpt || '';
                document.getElementById('metaDescription').value = p.meta_description || '';
                document.getElementById('grossEarnings').value = p.gross_earnings || '';
                document.getElementById('earningsCurrency').value = p.earnings_currency || '£';
                quill.root.innerHTML = p.content || '';

                document.getElementById('formTitle').textContent = 'Edit Project';
                document.getElementById('publishBtn').textContent = 'Update & Publish';
                document.getElementById('draftBtn').textContent = 'Update as Draft';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                document.getElementById('statusIndicator').style.display = 'block';
                document.getElementById('currentStatus').textContent = p.status;
                document.getElementById('currentProjectStatus').textContent = p.project_status;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { alert('Error loading project: ' + e.message); }
        };

        window._togglePublish = async function(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}/toggle-publish`, { method: 'POST' });
                const data = await res.json();
                if (data.success) loadProjects(); else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window._toggleActivity = async function(id) {
            try {
                const res = await fetch(`${API_BASE}/${id}/toggle-status`, { method: 'POST' });
                const data = await res.json();
                if (data.success) loadProjects(); else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        window._deleteProject = async function(id) {
            if (!confirm('Delete this project?')) return;
            try {
                const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) loadProjects(); else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (e) { alert('Error: ' + e.message); }
        };

        function resetForm() {
            editingId = null;
            document.getElementById('projectId').value = '';
            document.getElementById('title').value = '';
            document.getElementById('year').value = '';
            document.getElementById('yearEnd').value = '';
            document.getElementById('projectStatus').value = 'active';
            clearTechs();
            galleryImages = [];
            galleryLayout = 'single';
            document.getElementById('galleryLayout').value = 'single';
            document.querySelectorAll('#galleryLayoutPicker .gl-btn').forEach(b => b.classList.toggle('active', b.dataset.layout === 'single'));
            heroImageAlign = 'center center';
            document.getElementById('heroImageAlign').value = 'center center';
            document.querySelectorAll('#focalGrid .focal-cell').forEach(b => b.classList.toggle('active', b.dataset.align === 'center center'));
            renderGalleryThumbs();
            syncGalleryHidden();
            document.getElementById('imageFile').value = '';
            document.getElementById('galleryUrlInput').value = '';
            document.getElementById('excerpt').value = '';
            document.getElementById('metaDescription').value = '';
            document.getElementById('grossEarnings').value = '';
            document.getElementById('earningsCurrency').value = '£';
            quill.root.innerHTML = '';
            document.getElementById('formTitle').textContent = 'Create New Project';
            document.getElementById('publishBtn').textContent = 'Publish Project';
            document.getElementById('draftBtn').textContent = 'Save as Draft';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('statusIndicator').style.display = 'none';
        }
    })();
    </script>

    <style>
    .form-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--noir-gray); }
    .form-section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; color: var(--noir-silver); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } }
    #excerpt, #metaDescription { min-height: 60px; resize: vertical; }
    .status-badge { display: inline-block; min-width: 72px; text-align: center; }
    .status-published { background: #2ecc40; color: #fff; }
    .status-draft { background: #f0ad4e; color: #fff; }
    .ps-active { background: #2ecc40; color: #fff; }
    .ps-inactive { background: #e74c3c; color: #fff; }

    /* Image Browser Modal */
    .ib-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .ib-card {
        background: var(--noir-charcoal, #1a1a2e); border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
        border-radius: 12px; width: 90%; max-width: 700px; max-height: 80vh;
        display: flex; flex-direction: column;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .ib-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .ib-header h3 { margin: 0; font-size: 1.1rem; }
    .ib-close {
        background: none; border: none; color: rgba(255,255,255,0.6);
        font-size: 1.5rem; cursor: pointer; padding: 4px 8px; border-radius: 4px;
    }
    .ib-close:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .ib-tabs {
        display: flex; gap: 0; border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 0 20px;
    }
    .ib-tab {
        padding: 10px 18px; background: none; border: none; border-bottom: 2px solid transparent;
        color: rgba(255,255,255,0.5); cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
    }
    .ib-tab.active { color: #4a90d9; border-bottom-color: #4a90d9; }
    .ib-tab:hover:not(.active) { color: rgba(255,255,255,0.8); }
    .ib-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
    .ib-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .ib-item {
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 8px; overflow: hidden; transition: all 0.2s;
    }
    .ib-item:hover { border-color: rgba(255,255,255,0.2); }
    .ib-item img { width: 100%; height: 100px; object-fit: cover; display: block; }
    .ib-filename {
        display: block; padding: 4px 8px; font-size: 0.7rem;
        color: rgba(255,255,255,0.5); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .ib-actions { display: flex; gap: 4px; padding: 4px 8px 8px; }
    .ib-select-btn {
        flex: 1; padding: 4px 8px; background: #4a90d9; color: #fff;
        border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer;
    }
    .ib-select-btn:hover { background: #3a7bc8; }
    .ib-delete-btn {
        padding: 4px 8px; background: rgba(231,76,60,0.15); color: #e74c3c;
        border: 1px solid rgba(231,76,60,0.3); border-radius: 4px;
        font-size: 0.75rem; cursor: pointer;
    }
    .ib-delete-btn:hover { background: rgba(231,76,60,0.3); }
    @media (max-width: 600px) {
        .ib-grid { grid-template-columns: repeat(2, 1fr); }
        .ib-card { width: 95%; max-height: 90vh; }
    }

    /* Tech autocomplete */
    .tech-input-wrap {
        position: relative;
        display: flex; flex-wrap: wrap; align-items: center; gap: 6px;
        background: var(--noir-charcoal, #1a1a2e);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
        border-radius: 8px; padding: 6px 10px; min-height: 42px; cursor: text;
        transition: border-color 0.2s;
    }
    .tech-input-wrap:focus-within { border-color: var(--lz-accent, #c4788a); }
    .tech-tags { display: contents; }
    .tech-pill {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;
        white-space: nowrap; line-height: 1.4;
    }
    .tech-pill-x {
        background: none; border: none; color: inherit; cursor: pointer;
        font-size: 1rem; line-height: 1; padding: 0 0 0 2px; opacity: 0.6;
    }
    .tech-pill-x:hover { opacity: 1; }
    #techSearchInput {
        flex: 1; min-width: 120px; background: transparent; border: none; outline: none;
        color: var(--noir-white, #e0e0e0); font-size: 0.9rem; padding: 4px 0;
    }
    #techSearchInput::placeholder { color: rgba(255,255,255,0.3); }
    .tech-dropdown {
        display: none; position: absolute; top: 100%; left: 0; right: 0;
        background: var(--noir-charcoal, #1a1a2e);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.15));
        border-radius: 8px; margin-top: 4px; max-height: 220px; overflow-y: auto;
        z-index: 50; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .tech-dropdown-item {
        display: flex; align-items: center; gap: 8px;
        padding: 8px 12px; cursor: pointer; font-size: 0.85rem;
        color: var(--noir-white, #e0e0e0); transition: background 0.15s;
    }
    .tech-dropdown-item:hover, .tech-dropdown-item.active {
        background: rgba(255,255,255,0.08);
    }
    .tech-dd-dot {
        width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .tech-dd-cat {
        margin-left: auto; font-size: 0.7rem; opacity: 0.45; text-transform: capitalize;
    }
    .tech-category-picker {
        display: flex; align-items: center; gap: 8px; flex-basis: 100%;
        padding: 8px 0 2px; font-size: 0.82rem;
    }
    .tcp-label { color: rgba(255,255,255,0.6); white-space: nowrap; }
    #techCategorySelect {
        padding: 4px 8px; border-radius: 6px; font-size: 0.82rem;
        background: var(--noir-dark, #0f0f1a); color: var(--noir-white, #e0e0e0);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.15));
    }
    .tcp-add {
        padding: 4px 12px; border-radius: 6px; font-size: 0.82rem;
        background: var(--lz-accent, #c4788a); color: #fff; border: none; cursor: pointer;
    }
    .tcp-add:hover { opacity: 0.85; }
    .tcp-cancel {
        padding: 4px 10px; border-radius: 6px; font-size: 0.82rem;
        background: transparent; color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.15); cursor: pointer;
    }
    .tcp-cancel:hover { color: rgba(255,255,255,0.8); }

    /* Focal point grid picker */
    .focal-grid {
        display: grid;
        grid-template-columns: repeat(3, 28px);
        gap: 3px;
        width: fit-content;
    }
    .focal-cell {
        width: 28px; height: 28px;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.12);
        background: var(--noir-dark, #0f0f1a);
        cursor: pointer;
        position: relative;
        transition: all 0.15s;
        padding: 0;
    }
    .focal-cell::after {
        content: '';
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 8px; height: 8px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        transition: all 0.15s;
    }
    .focal-cell:hover { border-color: rgba(255,255,255,0.3); }
    .focal-cell:hover::after { background: rgba(255,255,255,0.4); }
    .focal-cell.active {
        border-color: var(--lz-accent, #c4788a);
    }
    .focal-cell.active::after {
        background: var(--lz-accent, #c4788a);
        width: 10px; height: 10px;
    }

    /* Gallery layout picker */
    .gallery-layout-picker { display: flex; gap: 6px; }
    .gl-btn {
        padding: 6px 16px; border-radius: 6px; font-size: 0.85rem;
        background: var(--noir-dark, #0f0f1a); color: rgba(255,255,255,0.5);
        border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: all 0.2s;
    }
    .gl-btn.active {
        background: var(--lz-accent, #c4788a); color: #fff;
        border-color: var(--lz-accent, #c4788a);
    }
    .gl-btn:hover:not(.active) { color: rgba(255,255,255,0.8); border-color: rgba(255,255,255,0.25); }

    /* Gallery thumbnails */
    .gallery-thumbs {
        display: flex; flex-wrap: wrap; gap: 8px; min-height: 60px;
        padding: 8px; border-radius: 8px;
        background: var(--noir-dark, #0f0f1a);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.1));
    }
    .gallery-empty {
        width: 100%; text-align: center; color: rgba(255,255,255,0.3);
        font-size: 0.85rem; margin: 10px 0;
    }
    .gallery-thumb {
        position: relative; width: 80px; height: 80px; border-radius: 6px;
        overflow: hidden; border: 2px solid transparent;
        cursor: grab; transition: border-color 0.2s, opacity 0.2s;
    }
    .gallery-thumb:hover { border-color: var(--lz-accent, #c4788a); }
    .gallery-thumb.dragging { opacity: 0.4; }
    .gallery-thumb.drag-over { border-color: #4a90d9; }
    .gallery-thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .gallery-thumb-num {
        position: absolute; top: 3px; left: 3px;
        background: rgba(0,0,0,0.7); color: #fff; font-size: 0.65rem;
        padding: 1px 5px; border-radius: 3px; line-height: 1.3;
    }
    .gallery-thumb-remove {
        position: absolute; top: 2px; right: 2px;
        background: rgba(231,76,60,0.85); color: #fff;
        border: none; border-radius: 50%; width: 18px; height: 18px;
        font-size: 0.75rem; line-height: 1; cursor: pointer;
        display: none; align-items: center; justify-content: center;
    }
    .gallery-thumb:hover .gallery-thumb-remove { display: flex; }
    .gallery-thumb-remove:hover { background: #e74c3c; }

    /* Inline image toolbar */
    .img-toolbar {
        position: fixed;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 5px 10px;
        background: var(--noir-charcoal, #1a1a2e);
        border: 1px solid var(--noir-gray, rgba(255,255,255,0.15));
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        white-space: nowrap;
    }
    .img-tb-group {
        display: flex;
        align-items: center;
        gap: 3px;
    }
    .img-tb-label {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.4);
        margin-right: 2px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }
    .img-tb-sep {
        width: 1px;
        height: 20px;
        background: rgba(255,255,255,0.12);
        margin: 0 6px;
    }
    .img-tb-btn {
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 0.78rem;
        background: var(--noir-dark, #0f0f1a);
        color: rgba(255,255,255,0.5);
        border: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: all 0.15s;
    }
    .img-tb-btn.active {
        background: var(--lz-accent, #c4788a);
        color: #fff;
        border-color: var(--lz-accent, #c4788a);
    }
    .img-tb-btn:hover:not(.active) {
        color: rgba(255,255,255,0.8);
        border-color: rgba(255,255,255,0.25);
    }

    /* Selected image highlight in editor */
    .ql-editor img.img-selected {
        outline: 2px solid var(--lz-accent, #c4788a);
        outline-offset: 2px;
        border-radius: 4px;
    }

    /* Editor-side image sizing */
    .ql-editor img[data-size="small"] { max-width: 33%; }
    .ql-editor img[data-size="medium"] { max-width: 50%; }
    .ql-editor img[data-size="full"] { max-width: 100%; }
    </style>
</body>
</html>
