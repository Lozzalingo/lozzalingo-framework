<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Registry - Admin</title>
    <script src="{{ url_for('admin.static', filename='js/admin-theme.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/newseditor.css') }}">
    <link rel="stylesheet" href="{{ url_for('admin.static', filename='css/admin-theme.css') }}">
</head>
<body>
    {% include 'header.html' ignore missing %}

    <div class="editor-container">
        <header class="editor-header">
            <h1>Technology Registry</h1>
            <div class="header-actions">
                <button class="lz-theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"><span class="theme-icon"></span></button>
                <a href="{{ url_for('admin.dashboard') }}" class="back-link">Back to Dashboard</a>
            </div>
        </header>

        <div class="editor-content">
            <!-- Add form -->
            <div class="editor-form">
                <h2>Add Technology</h2>
                <form id="techForm" class="tr-form">
                    <div class="tr-form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="techName">Technology Name</label>
                            <input type="text" id="techName" placeholder="e.g. python, arduino, figma" required>
                        </div>
                        <div class="form-group">
                            <label for="techCategory">Category</label>
                            <select id="techCategory" required>
                                <option value="software">Software</option>
                                <option value="hardware">Hardware</option>
                                <option value="marketing">Marketing</option>
                                <option value="clients">Clients</option>
                                <option value="equipment">Equipment</option>
                                <option value="logistics">Logistics</option>
                                <option value="materials">Materials</option>
                                <option value="services">Services</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button type="submit" class="btn-primary">Add</button>
                        </div>
                    </div>
                </form>

                <div class="tr-preview" id="preview" style="display: none;">
                    <label>Preview:</label>
                    <span class="tech-pill" id="previewPill" data-cat="software"></span>
                </div>
            </div>

            <!-- Registry table -->
            <div class="articles-list">
                <div class="list-header">
                    <h2>Registered Technologies</h2>
                    <div class="filter-controls">
                        <input type="text" id="searchInput" class="filter-input" placeholder="Search...">
                        <select id="filterCategory" class="filter-select">
                            <option value="all">All Categories</option>
                            <option value="software">Software</option>
                            <option value="hardware">Hardware</option>
                            <option value="marketing">Marketing</option>
                            <option value="clients">Clients</option>
                            <option value="equipment">Equipment</option>
                            <option value="logistics">Logistics</option>
                            <option value="services">Services</option>
                            <option value="other">Other</option>
                        </select>
                        <span id="entryCount" class="item-count"></span>
                    </div>
                </div>
                <div id="registryList"></div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const API = '/admin/projects-editor/api/tech-registry';
        let entries = [];

        loadRegistry();

        // Live preview
        const nameInput = document.getElementById('techName');
        const catSelect = document.getElementById('techCategory');
        const preview = document.getElementById('preview');
        const previewPill = document.getElementById('previewPill');

        nameInput.addEventListener('input', updatePreview);
        catSelect.addEventListener('change', updatePreview);

        function updatePreview() {
            const name = nameInput.value.trim();
            if (name) {
                preview.style.display = 'flex';
                previewPill.textContent = name;
                previewPill.dataset.cat = catSelect.value;
            } else {
                preview.style.display = 'none';
            }
        }

        // Submit
        document.getElementById('techForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = nameInput.value.trim();
            const category = catSelect.value;
            if (!name) return;

            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, category })
                });
                const data = await res.json();
                if (data.success) {
                    nameInput.value = '';
                    preview.style.display = 'none';
                    loadRegistry();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        });

        // Search & filter
        document.getElementById('searchInput').addEventListener('input', renderList);
        document.getElementById('filterCategory').addEventListener('change', renderList);

        async function loadRegistry() {
            try {
                const res = await fetch(API);
                entries = await res.json();
                renderList();
            } catch (err) {
                console.error('Failed to load registry:', err);
            }
        }

        function renderList() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterCategory').value;
            const container = document.getElementById('registryList');

            let filtered = entries.filter(e => {
                if (filter !== 'all' && e.category !== filter) return false;
                if (search && !e.name.includes(search)) return false;
                return true;
            });

            document.getElementById('entryCount').textContent =
                `${filtered.length} entr${filtered.length !== 1 ? 'ies' : 'y'}`;

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No entries found</p></div>';
                return;
            }

            // Group by category
            const groups = {};
            filtered.forEach(e => {
                if (!groups[e.category]) groups[e.category] = [];
                groups[e.category].push(e);
            });

            const catOrder = ['software', 'hardware', 'marketing', 'clients', 'equipment', 'logistics', 'materials', 'services', 'other'];
            container.innerHTML = catOrder
                .filter(cat => groups[cat])
                .map(cat => `
                    <div class="tr-category-box tr-cat-box-${cat}">
                        <div class="tr-category-header">${cat}</div>
                        <div class="tr-pills-wrap">
                            ${groups[cat].map(e => `
                                <span class="tech-pill" data-cat="${e.category}">
                                    ${escapeHtml(e.name)}<button class="tr-pill-x" onclick="window._deleteTech('${e.name.replace(/'/g, "\\'")}')">&times;</button>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
        }

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        window._deleteTech = async function(name) {
            if (!confirm(`Remove "${name}" from registry?`)) return;
            try {
                const res = await fetch(`${API}/${encodeURIComponent(name)}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) loadRegistry();
                else alert('Error: ' + (data.error || 'Unknown error'));
            } catch (err) {
                alert('Error: ' + err.message);
            }
        };
    })();
    </script>

    <style>
    .tr-form-row {
        display: flex;
        gap: 16px;
        align-items: flex-start;
    }
    @media (max-width: 768px) {
        .tr-form-row { flex-direction: column; }
    }
    .tr-preview {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 16px;
        padding: 12px 16px;
        background: var(--lz-bg-elevated, rgba(255,255,255,0.03));
        border: 1px solid var(--lz-border, rgba(255,255,255,0.08));
        border-radius: 8px;
    }
    .tr-preview label {
        font-size: 0.85rem;
        color: var(--lz-text-muted, rgba(255,255,255,0.5));
    }

    /* Category boxes */
    .tr-category-box {
        margin-bottom: 16px;
        border-radius: 10px;
        border: 1px solid var(--lz-border, #2a2a2a);
        overflow: hidden;
    }
    .tr-category-header {
        padding: 10px 16px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .tr-pills-wrap {
        padding: 12px 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        background: var(--lz-bg-card, #131313);
    }

    /* Category box colours */
    .tr-cat-box-software .tr-category-header  { background: rgba(212,168,85,0.15); color: #d4a855; }
    .tr-cat-box-hardware .tr-category-header  { background: rgba(0,150,255,0.15); color: #4a9eff; }
    .tr-cat-box-marketing .tr-category-header { background: rgba(255,160,50,0.15); color: #ffa032; }
    .tr-cat-box-clients .tr-category-header   { background: rgba(230,80,100,0.15); color: #e65064; }
    .tr-cat-box-equipment .tr-category-header { background: rgba(180,180,195,0.15); color: #b4b4c3; }
    .tr-cat-box-logistics .tr-category-header { background: rgba(46,204,64,0.15); color: #2ecc40; }
    .tr-cat-box-materials .tr-category-header { background: rgba(100,200,240,0.15); color: #64c8f0; }
    .tr-cat-box-services .tr-category-header  { background: rgba(26,214,186,0.15); color: #1ad6ba; }
    .tr-cat-box-other .tr-category-header     { background: rgba(177,100,255,0.15); color: #b164ff; }

    /* Tech pills */
    .tech-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        background: rgba(74,144,217,0.15);
        color: #4a90d9;
        border: 1px solid rgba(74,144,217,0.3);
    }
    .tech-pill[data-cat="software"]  { background: rgba(212,168,85,0.15); color: #d4a855; border-color: rgba(212,168,85,0.3); }
    .tech-pill[data-cat="hardware"]  { background: rgba(0,150,255,0.15); color: #4a9eff; border-color: rgba(0,150,255,0.3); }
    .tech-pill[data-cat="marketing"] { background: rgba(255,160,50,0.15); color: #ffa032; border-color: rgba(255,160,50,0.3); }
    .tech-pill[data-cat="clients"]   { background: rgba(230,80,100,0.15); color: #e65064; border-color: rgba(230,80,100,0.3); }
    .tech-pill[data-cat="equipment"] { background: rgba(180,180,195,0.15); color: #b4b4c3; border-color: rgba(180,180,195,0.3); }
    .tech-pill[data-cat="logistics"] { background: rgba(46,204,64,0.15); color: #2ecc40; border-color: rgba(46,204,64,0.3); }
    .tech-pill[data-cat="materials"] { background: rgba(100,200,240,0.15); color: #64c8f0; border-color: rgba(100,200,240,0.3); }
    .tech-pill[data-cat="services"]  { background: rgba(26,214,186,0.15); color: #1ad6ba; border-color: rgba(26,214,186,0.3); }
    .tech-pill[data-cat="other"]     { background: rgba(177,100,255,0.15); color: #b164ff; border-color: rgba(177,100,255,0.3); }

    /* X button inside pill */
    .tr-pill-x {
        background: none;
        border: none;
        color: inherit;
        font-size: 1.1rem;
        line-height: 1;
        cursor: pointer;
        opacity: 0.5;
        padding: 0;
        margin-left: 2px;
        transition: opacity 0.15s;
    }
    .tr-pill-x:hover {
        opacity: 1;
    }
    </style>
</body>
</html>
