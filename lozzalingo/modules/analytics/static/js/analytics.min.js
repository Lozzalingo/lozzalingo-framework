class AnalyticsClient{constructor(){this.currentRoute=this.getCurrentRoute(),this.routeHistory=[],this.rateLimiterByDevice=this.generateUltraStableFingerprint(),this.sessionData=this.collectSessionData(),this.pageLoadTime=Date.now(),this.loadDeviceDetailsFromSession(),this.rateLimiterByDevice.then(e=>{this.deviceDetails=e,this.saveDeviceDetailsToSession(e),this.pageViewLogged||(this.logPageViewClient(),this.pageViewLogged=!0)}),this.setupRouteTracking(),this.setupEventListeners()}saveDeviceDetailsToSession(e){try{sessionStorage.setItem("analytics_device_details",JSON.stringify(e))}catch(e){}}loadDeviceDetailsFromSession(){try{const e=sessionStorage.getItem("analytics_device_details");e&&(this.deviceDetails=JSON.parse(e),console.log("[Analytics] Loaded device details from session:",this.deviceDetails))}catch(e){}}getCurrentRoute(){return{full_url:window.location.href,pathname:window.location.pathname,search:window.location.search,hash:window.location.hash,host:window.location.host,protocol:window.location.protocol,route_name:this.getRouteName(window.location.pathname),timestamp:(new Date).toISOString()}}getRouteName(e){const t={"/":"home","/analytics":"analytics","/news/editor":"new_editor","/login":"login","/register":"register"};return t[e]?t[e]:e.startsWith("/user/")?"user_profile":e.startsWith("/item/")?"item_detail":e.startsWith("/category/")?"category_page":e.startsWith("/admin/")?"admin_panel":e.match(/^\/\d+$/)?"numeric_id_page":e.replace(/^\//,"").replace(/\//g,"_")||"unknown_route"}setupRouteTracking(){window.addEventListener("popstate",e=>{this.handleRouteChange("browser_navigation",e.state)}),this.interceptHistoryMethods(),window.addEventListener("hashchange",e=>{this.handleRouteChange("hash_change",{oldURL:e.oldURL,newURL:e.newURL})}),document.addEventListener("click",e=>{const t=e.target.closest("a");if(t&&t.href){const e=new URL(t.href);e.host===window.location.host&&this.logInteraction("internal_link_click",{destination_url:t.href,destination_route:this.getRouteName(e.pathname),link_text:t.textContent?.substring(0,100),current_route:this.currentRoute.route_name})}})}interceptHistoryMethods(){const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),setTimeout(()=>this.handleRouteChange("push_state",t[0]),0)},history.replaceState=(...e)=>{t.apply(history,e),setTimeout(()=>this.handleRouteChange("replace_state",e[0]),0)}}handleRouteChange(e,t=null){const n={...this.currentRoute},i=this.getCurrentRoute(),o=new Date(i.timestamp)-new Date(n.timestamp);this.currentRoute=i,this.routeHistory.push({...n,time_spent_ms:o,exit_type:e}),this.routeHistory.length>10&&(this.routeHistory=this.routeHistory.slice(-10)),this.logRouteChange(n,i,e,o,t)}async logRouteChange(e,t,n,i,o){try{const a=this.deviceDetails||await this.rateLimiterByDevice,r={type:"route_change",navigation_type:n,from_route:e.route_name,from_url:e.full_url,to_route:t.route_name,to_url:t.full_url,time_spent_ms:i,time_spent_seconds:Math.round(i/1e3),state:o,route_history:this.routeHistory.slice(-3),deviceDetails:a,timestamp:t.timestamp,page_url:t.full_url};await fetch("/admin/analytics/api/log-interaction",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),console.log(`Route change logged: ${e.route_name} -> ${t.route_name} (${Math.round(i/1e3)}s)`)}catch(e){console.warn("Route change logging failed:",e)}}async logPageViewClient(){try{const e={type:"page_view_client",deviceDetails:this.deviceDetails,timestamp:(new Date).toISOString(),load_time:Date.now()-this.pageLoadTime,route_info:this.currentRoute,is_returning_visitor:this.routeHistory.length>0,session_page_count:this.routeHistory.length+1,...this.sessionData};await fetch("/admin/analytics/api/log-interaction",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),console.log("Client page view logged with route info:",this.currentRoute.route_name)}catch(e){console.warn("Client page view logging failed:",e)}}trackRouteEvent(e,t={}){this.logInteraction(`route_${e}`,{current_route:this.currentRoute.route_name,current_url:this.currentRoute.full_url,...t})}getSessionRouteAnalytics(){return{current_route:this.currentRoute,route_history:this.routeHistory,total_routes_visited:this.routeHistory.length+1,total_session_time:this.routeHistory.reduce((e,t)=>e+t.time_spent_ms,0),unique_routes:[...new Set([...this.routeHistory.map(e=>e.route_name),this.currentRoute.route_name])],most_visited_route:this.getMostVisitedRoute()}}getMostVisitedRoute(){const e={};return this.routeHistory.forEach(t=>{e[t.route_name]=(e[t.route_name]||0)+1}),e[this.currentRoute.route_name]=(e[this.currentRoute.route_name]||0)+1,Object.entries(e).reduce((t,n)=>e[t[0]]>e[n[0]]?t:n)[0]}collectSessionData(){return{...this.getCurrentRoute(),referrer_route:this.getReferrerRoute(),entry_route:this.currentRoute.route_name,screen_resolution:`${screen.width}x${screen.height}`,viewport_size:`${window.innerWidth}x${window.innerHeight}`}}parseURLParameters(){const e=new URLSearchParams(window.location.search),t={};for(const[n,i]of e)t[n]=i;return Object.keys(t).length>0?t:null}getReferrerRoute(){if(!document.referrer)return null;try{const e=new URL(document.referrer);return e.host===window.location.host?this.getRouteName(e.pathname):"external"}catch{return"unknown"}}async generateUltraStableFingerprint(){const[e,t,n]=await Promise.all([this.generateStableCanvasFingerprint(),this.generateCoreWebGLFingerprint()]),i=[`canvas:${e}`,`webgl:${t}`,`hardware:${this.getCoreHardwareFingerprint()}`,`audio:${n}`,`browser:${this.getEssentialBrowserFingerprint()}`].join("||");return console.log("Ultra-stable fingerprint generated:",i.substring(0,16)+"..."),i}generateStableCanvasFingerprint(){try{const e=document.createElement("canvas");e.width=200,e.height=50;const t=e.getContext("2d");return t.textBaseline="top",t.font="14px Arial",t.fillStyle="#FF0000",t.fillRect(2,2,96,20),t.fillStyle="#00FF00",t.fillRect(102,2,96,20),t.fillStyle="#0000FF",t.fillText("Stable123",4,25),t.beginPath(),t.arc(170,35,10,0,2*Math.PI),t.fillStyle="#FFFF00",t.fill(),e.toDataURL()}catch(e){return"canvas_unavailable"}}async generateCoreWebGLFingerprint(){try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"webgl_unavailable";const n=[],i=t.getExtension("WEBGL_debug_renderer_info");if(i){let e=t.getParameter(i.UNMASKED_RENDERER_WEBGL),o=t.getParameter(i.UNMASKED_VENDOR_WEBGL);e=this.normalizeGPUString(e),o=this.normalizeGPUString(o),n.push(`vendor:${o}`,`renderer:${e}`)}[t.MAX_TEXTURE_SIZE,t.MAX_CUBE_MAP_TEXTURE_SIZE,t.MAX_RENDERBUFFER_SIZE,t.MAX_VERTEX_ATTRIBS,t.MAX_VERTEX_UNIFORM_VECTORS,t.MAX_FRAGMENT_UNIFORM_VECTORS,t.MAX_VARYING_VECTORS].forEach(e=>{try{const i=t.getParameter(e);n.push(Array.isArray(i)?i.join(","):String(i))}catch(e){n.push("unknown")}});const o=["WEBGL_debug_renderer_info","OES_texture_float","OES_standard_derivatives","WEBGL_lose_context"],a=t.getSupportedExtensions()||[],r=o.map(e=>a.includes(e)).join(",");return n.push(`stable_ext:${r}`),n.join("|")}catch(e){return"webgl_error"}}normalizeGPUString(e){return e?e.replace(/\d+\.\d+[\d.]*\w*/g,"").replace(/\([^)]*\d+[^)]*\)/g,"").replace(/\d{1,2}\/\d{1,2}\/\d{2,4}/g,"").replace(/\d+\.\d+\.\d+[\d.]*-?\w*/g,"").replace(/rev\s*\w+/gi,"").replace(/\brev\.\s*\w+/gi,"").replace(/build\s*\d+/gi,"").replace(/\s*-\s*\d+\.\d+\.\d+/g,"").replace(/[\(\)\[\]]/g," ").replace(/\s+/g," ").replace(/^\s+|\s+$/g,"").split(/\s+/).slice(0,3).join(" ").toLowerCase():"unknown"}getCoreHardwareFingerprint(){return[screen.width,screen.height,screen.colorDepth,navigator.hardwareConcurrency||0,navigator.deviceMemory||0,navigator.maxTouchPoints||0,navigator.platform,Math.floor((new Date).getTimezoneOffset()/60)].join("|")}getEssentialBrowserFingerprint(){let e=navigator.userAgent||"";return[this.extractBrowserCore(e),navigator.language.split("-")[0],navigator.cookieEnabled,navigator.maxTouchPoints>0,"localStorage"in window,"indexedDB"in window].join("|")}extractBrowserCore(e){return e.includes("Firefox")?"firefox":e.includes("Chrome")&&!e.includes("Edge")?"chrome":e.includes("Safari")&&!e.includes("Chrome")?"safari":e.includes("Edge")?"edge":e.includes("Opera")?"opera":"unknown"}async createStableHash(e){if(window.crypto&&window.crypto.subtle)try{const t=(new TextEncoder).encode(e),n=await window.crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map(e=>e.toString(16).padStart(2,"0")).join("")}catch(e){console.warn("SubtleCrypto unavailable, using fallback")}let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(16).padStart(8,"0")}detectDeviceInfo(){const e=navigator.userAgent.toLowerCase();let t="unknown",n="unknown",i="low";return e.includes("windows")?(t="windows",i="high"):e.includes("mac os x")||e.includes("macos")?(t="macos",i="high"):e.includes("android")?(t="android",i="high"):e.includes("linux")?(t="linux",i="medium"):(e.includes("iphone")||e.includes("ipad"))&&(t="ios",i="high"),e.includes("iphone")||e.includes("ipad")||e.includes("macintosh")||e.includes("mac os")?(n="apple",i="high"):e.includes("windows")?(n="microsoft",i="high"):e.includes("android")?e.includes("samsung")?(n="samsung",i="high"):e.includes("huawei")?(n="huawei",i="high"):e.includes("xiaomi")?(n="xiaomi",i="high"):e.includes("oppo")?(n="oppo",i="high"):e.includes("vivo")?(n="vivo",i="high"):e.includes("oneplus")?(n="oneplus",i="high"):e.includes("pixel")?(n="google",i="high"):(n="android",i="medium"):e.includes("linux")&&(n="linux",i="low"),{device_os:t,device_brand:n,device_confidence:i}}collectSessionData(){const e=this.detectDeviceInfo();return{screen_resolution:`${screen.width}x${screen.height}`,viewport_size:`${window.innerWidth}x${window.innerHeight}`,color_depth:screen.colorDepth,pixel_ratio:window.devicePixelRatio||1,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,language:navigator.language,languages:navigator.languages?navigator.languages.join(","):"",platform:navigator.platform,cookie_enabled:navigator.cookieEnabled,online:navigator.onLine,do_not_track:navigator.doNotTrack||"not_specified",hardware_concurrency:navigator.hardwareConcurrency||"unknown",device_memory:navigator.deviceMemory||"unknown",max_touch_points:navigator.maxTouchPoints||0,connection_type:navigator.connection?navigator.connection.effectiveType:"unknown",connection_downlink:navigator.connection?navigator.connection.downlink:"unknown",java_enabled:!!navigator.javaEnabled&&navigator.javaEnabled(),pdf_viewer_enabled:navigator.pdfViewerEnabled||!1,webdriver:navigator.webdriver||!1,local_storage_enabled:this.testLocalStorage(),session_storage_enabled:this.testSessionStorage(),indexed_db_enabled:this.testIndexedDB(),page_url:window.location.href,page_title:document.title,referrer:document.referrer||null,protocol:window.location.protocol,domain:window.location.hostname,path:window.location.pathname,search_params:window.location.search,hash:window.location.hash,device_os:e.device_os,device_brand:e.device_brand,device_confidence:e.device_confidence,session_page_count:this.routeHistory.length+1}}testLocalStorage(){try{return localStorage.setItem("test","test"),localStorage.removeItem("test"),!0}catch(e){return!1}}testSessionStorage(){try{return sessionStorage.setItem("test","test"),sessionStorage.removeItem("test"),!0}catch(e){return!1}}testIndexedDB(){return"indexedDB"in window}async logPageViewClient(){try{const e={type:"page_view_client",deviceDetails:this.deviceDetails,timestamp:(new Date).toISOString(),load_time:Date.now()-this.pageLoadTime,...this.sessionData};await fetch("/admin/analytics/api/log-interaction",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),console.log("Client page view logged with ultra-stable fingerprint")}catch(e){console.warn("Client page view logging failed:",e)}}async logInteraction(e,t={}){try{const n=document.getElementById("email")?.value?.trim()||null,i={type:e,deviceDetails:this.deviceDetails,email:n,timestamp:(new Date).toISOString(),page_url:window.location.href,viewport_size:`${window.innerWidth}x${window.innerHeight}`,...t};await fetch("/admin/analytics/api/log-interaction",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}catch(e){console.warn("Analytics logging failed:",e)}}setupEventListeners(){this.rateLimiterByDevice.then(e=>{const t=document.getElementById("browser_deviceDetails");t&&(t.value=e,console.log("Ultra-stable deviceDetails set in form:",e.substring(0,16)+"..."))});const e=document.querySelector('input[type="file"]');e&&e.addEventListener("change",e=>{const t=e.target.files[0];this.logInteraction("file_upload",{has_file:!!t,file_name:t?t.name:null,file_size:t?t.size:null,file_type:t?t.type:null,file_last_modified:t?new Date(t.lastModified).toISOString():null})});let t=!1;document.addEventListener("click",e=>{!t&&e.target.closest("#designForm")&&(t=!0,this.logInteraction("form_start",{click_target:e.target.tagName.toLowerCase(),click_coordinates:{x:e.clientX,y:e.clientY}}))}),window.addEventListener("beforeunload",async()=>{try{const e=await this.rateLimiterByDevice,t=Date.now()-this.pageLoadTime,n={type:"page_exit",deviceDetails:e,time_spent:Math.round(t/1e3)},i=new Blob([JSON.stringify(n)],{type:"application/json"});navigator.sendBeacon("/admin/analytics/api/log-interaction",i)}catch(e){console.warn("sendBeacon failed:",e)}}),window.addEventListener("error",e=>{e.filename&&(e.filename.includes("extension://")||e.filename.includes("chrome-extension://")||e.filename.includes("moz-extension://"))||this.logInteraction("javascript_error",{error_message:e.message,error_filename:e.filename||"unknown",error_line:e.lineno||0,error_column:e.colno||0,user_agent:navigator.userAgent,url:window.location.href})}),document.addEventListener("change",e=>{"INPUT"!==e.target.tagName&&"SELECT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName||this.logInteraction(`field_change_${e.target.name||e.target.id}`)}),document.addEventListener("click",e=>{if("BUTTON"===e.target.tagName||"submit"===e.target.type)this.logInteraction(`button_click_${e.target.name||e.target.id||"unnamed"}`);else if("A"===e.target.tagName&&e.target.href){const t=e.target.name||e.target.id||e.target.className||"unnamed_link";this.logInteraction(`link_click_${t}`)}});const n=document.querySelector('textarea[name="prompt"]');if(n){let e;n.addEventListener("input",t=>{clearTimeout(e),e=setTimeout(()=>{this.logInteraction("prompt_typing")},1e3)})}const i=document.querySelector('input[name="email"]');i&&i.addEventListener("blur",e=>{e.target.value.trim()&&this.logInteraction("email_entered")})}getFormCompletion(){const e=document.getElementById("designForm");if(!e)return 0;const t=e.querySelectorAll("[required]"),n=Array.from(t).filter(e=>e.value.trim());return Math.round(n.length/t.length*100)}trackCustomEvent(e,t={}){this.logInteraction(e,t)}async validateFingerprint(){const e=await this.generateUltraStableFingerprint()===this.deviceDetails;return console.log("Fingerprint validation:",e?"CONSISTENT":"CHANGED"),e}}document.addEventListener("DOMContentLoaded",function(){window.analyticsClient||(window.analyticsClient=new AnalyticsClient)});